<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Manage Levels | WebScape</title>
    <link
      rel="icon"
      href="/static/images/playground-mode.png"
      type="image/png"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap");

      :root {
        --bg-color: #240e44;
        --secondary-color: #2d2c2f;
        --accent-color: #ff66c4;
      }

      ::placeholder {
        color: #d3d3d394 !important;
      }
      .text-muted {
        color: #d3d3d394 !important;
      }

      * {
        list-style-type: none;
        text-decoration: none;
      }
      body,
      html {
        scrollbar-width: thin;
        scrollbar-color: var(--accent-color) var(--secondary-color);
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: var(--bg-color);
        color: #a9a9a9;
        font-family: "Montserrat", sans-serif;
      }

      .login-input {
        background-color: transparent;
        border: none;
        border-bottom: 2px solid #fff;
        border-radius: 0;
        color: #fff;
      }

      .login-input::placeholder {
        color: #aaa;
      }

      .btn-pink {
        background-color: #ff5fc5;
        color: white;
        font-weight: bold;
        letter-spacing: 1px;
        border-radius: 8px;
      }

      .btn-pink:hover {
        background-color: #ff40b5;
      }

      .text-pink {
        color: #ff5fc5;
        cursor: pointer;
      }

      .text-pink:hover {
        color: #ff40b5;
        text-decoration: underline;
      }
      /* ------- */
      .sidebar {
        background-color: #3a1464;
        width: 90px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        gap: 35px;
      }
      .sidebar .nav-item {
        text-align: center;
        font-weight: 500;
        font-size: 14px;
        color: #a9a9a9;
        user-select: none;
        cursor: pointer;
      }
      .sidebar .nav-item i {
        font-size: 28px;
        display: block;
        margin-bottom: 6px;
        color: #a9a9a9;
      }
      .sidebar .nav-item.badges i {
        color: #bfbfbf;
      }
      .sidebar .nav-item.account i {
        font-size: 32px;
        color: #bfbfbf;
      }
      .sidebar .nav-item:hover {
        color: #ff69b4;
      }
      .sidebar .nav-item:hover i {
        color: #ff69b4;
      }
      .sidebar .nav-item a {
        text-decoration: none;
        color: #a9a9a9;
      }
      .sidebar .nav-item a:hover {
        color: #ff69b4;
      }
      .sidebar .nav-item.active {
        color: #ff69b4;
      }
      .sidebar .nav-item.active i {
        color: #ff69b4;
      }
      .sidebar .nav-item.active a {
        color: #ff69b4;
      }

      main {
        margin-left: 80px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 0 15px;
      }
      .section {
        margin-left: 80px;
        height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 0 15px;
      }
      .section h1 {
        font-family: "Luckiest Guy", sans-serif;
        font-size: 4vw;
        color: #ff69b4;
        margin-bottom: 0;
        user-select: none;
      }
      h1 {
        font-family: "Luckiest Guy", sans-serif;
        font-size: 9.5vw;
        color: #ff69b4;
        margin-bottom: 0;
        user-select: none;
      }
      h2 {
        font-family: "Anton", sans-serif;
        font-weight: 700;
        font-size: 2.3vw;
        color: #6f2dbd;
        margin-top: 0;
        margin-bottom: 40px;
        user-select: none;
      }
      .book-icon {
        color: #b3b3b3;
        font-size: 18vw;
        width: 300px;
        user-select: none;
        margin-bottom: 50px;
      }

      @media (max-width: 575.98px) {
        .sidebar {
          width: 60px;
          padding-top: 15px;
          gap: 35px;
        }
        .sidebar .nav-item {
          font-size: 11px;
        }
        .sidebar .nav-item i {
          font-size: 22px;
          margin-bottom: 3px;
        }
        .sidebar .nav-item.account i {
          font-size: 26px;
        }
      }
      /* dashboard style */
      .main-content {
        margin-left: 90px;
        padding: 2rem 0 2rem 0;
        min-height: 100vh;
      }
      .dashboard-title {
        font-family: "Luckiest Guy", cursive;
        font-size: 2.5vw;
        color: var(--accent-color);
        margin-bottom: 40px;
        text-align: left;
        letter-spacing: 2px;
      }
      .dashboard-cards {
        display: flex;
        gap: 24px;
        justify-content: flex-start;
        margin-bottom: 40px;
        flex-wrap: wrap;
      }
      .dashboard-card {
        position: relative;
        background: #2d145c;
        border: 2px solid #a259ff;
        /* border-radius: 14px; */
        padding: 20px 5px 18px 40px;
        display: flex;
        align-items: center;
        min-width: 180px;
        max-width: 100%;
        box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1);
        gap: 3rem;
        flex: 1 1 220px;
      }
      .dashboard-icon {
        font-size: 75px;
        color: #d3d3d3;
        margin-right: 8px;
      }
      .dashboard-card-content {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
      }
      .dashboard-card-number {
        font-size: 1.7rem;
        font-family: "Luckiest Guy", cursive;
        color: var(--accent-color);
        font-weight: bold;
        margin-bottom: 0.1em;
      }
      .dashboard-card-label {
        font-size: 1.1rem;
        color: #d3d3d3;
        font-family: "Montserrat", sans-serif;
        font-weight: 7 00;
        text-align: left;
      }
      .web-traffic-section {
        margin-top: 60px;
        text-align: left;
      }
      .web-traffic-title {
        font-family: "Luckiest Guy", cursive;
        font-size: 2.2vw;
        color: var(--accent-color);
        margin-bottom: 18px;
        letter-spacing: 1px;
      }
      .web-traffic-chart-container {
        background: #2d145c;
        /* border-radius: 18px; */
        padding: 30px;
        box-shadow: 0 4px 24px 0 rgba(0, 0, 0, 0.1);
        max-width: 98vw;
        margin-bottom: 20px;
      }
      .web-traffic-legend {
        margin-top: 10px;
        font-size: 1.1rem;
        color: #fff;
        display: flex;
        gap: 18px;
        align-items: center;
      }
      .legend-last-year {
        display: inline-block;
        width: 18px;
        height: 10px;
        background: #5eeaff;
        border-radius: 3px;
        margin-right: 6px;
      }
      .legend-current-year {
        display: inline-block;
        width: 18px;
        height: 10px;
        background: #ff66c4;
        border-radius: 3px;
        margin-right: 6px;
      }
      @media (max-width: 900px) {
        .dashboard-cards {
          flex-direction: column;
          align-items: stretch;
          gap: 18px;
        }
        .dashboard-card {
          min-width: 0;
          width: 100%;
          padding: 16px 12px 14px 12px;
        }
      }
      @media (max-width: 576px) {
        .dashboard-title {
          font-size: 8vw;
        }
        .dashboard-cards {
          gap: 12px;
        }
        .dashboard-card {
          flex-direction: row;
          padding: 10px 6px 10px 6px;
        }
        .dashboard-icon {
          font-size: 24px;
          margin-right: 6px;
        }
        .dashboard-card-number {
          font-size: 1.1rem;
        }
        .dashboard-card-label {
          font-size: 0.9rem;
        }
        .web-traffic-chart-container {
          padding: 10px 2px 2px 2px;
          width: 100vw;
        }
      }

      button.btn.btn-pink.dropdown-toggle.show {
        background-color: #2d145c;
        border: 2px solid #a259ff;
        color: #ff69b4;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar d-flex flex-column align-items-center">
      <div class="nav-item levels">
        <a href="/"
          ><img
            src="/static/images/book-icon.png"
            alt="webscape-logo"
            width="60px"
        /></a>
        <br />
      </div>
      <div class="nav-item levels">
        <a href="/admin/dashboard">
          <i class="fas fa-tachometer-alt" aria-hidden="true"></i>
          <span>Dashboard</span>
        </a>
      </div>
      <div class="nav-item badges">
        <a href="/admin/users">
          <i class="fas fa-users" aria-hidden="true"></i>
          <span>Users</span>
        </a>
      </div>
      <div class="nav-item options active">
        <a href="#">
          <i class="fas fa-paint-brush" aria-hidden="true"></i>
          <span>Levels</span>
        </a>
      </div>
      <div class="nav-item options">
        <a href="/admin/rankings">
          <i class="fas fa-medal" aria-hidden="true"></i>
          <span>Rankings</span>
        </a>
      </div>
      <div class="nav-item account mt-auto mb-4">
        <a href="/logout">
          <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
          <span>Logout</span>
        </a>
      </div>
    </nav>
    <!-- Main Content -->
    <div class="main-content">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h1 class="dashboard-title mb-0">Manage Levels</h1>
          <button
            class="btn btn-pink"
            data-bs-toggle="modal"
            data-bs-target="#addLevelModal"
          >
            <i class="fas fa-plus me-2"></i>Add New Level
          </button>
        </div>

        <!-- Levels Grid -->
        <div class="row g-4">
          {% for level in levels %}
          <div class="col-md-6 col-lg-4" data-level-id="{{ level.id }}">
            <div
              class="card h-100"
              style="background: #2d145c; border: 2px solid #a259ff"
            >
              <div class="card-body position-relative">
                <span
                  class="badge bg-pink position-absolute top-0 end-0 m-3"
                  style="background: #ff69b4"
                >
                  <i class="fas fa-book me-1"></i>
                  <span class="chapter-count-{{ level.id }}"
                    >{{ level.chapter_count }}</span
                  >
                </span>
                <h5 class="card-title text-pink mb-3">{{ level.title }}</h5>
                <p class="card-text" style="color: #d3d3d3; min-height: 60px">
                  {{ level.description }}
                </p>
                <div
                  class="d-flex justify-content-between align-items-center mt-3"
                >
                  <div class="dropdown">
                    <button
                      class="btn btn-pink dropdown-toggle"
                      type="button"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                    >
                      <i class="fas fa-cog me-1"></i>Manage
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                      <li>
                        <a
                          class="dropdown-item"
                          href="#"
                          onclick="showChaptersList('{{ level.id }}')"
                        >
                          <i class="fas fa-list me-2"></i>View Chapters
                        </a>
                      </li>
                      <li><hr class="dropdown-divider" /></li>
                      <li>
                        <a
                          class="dropdown-item text-danger"
                          href="#"
                          onclick="deleteLevel('{{ level.id }}')"
                        >
                          <i class="fas fa-trash me-2"></i>Delete Level
                        </a>
                      </li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Toast Container for Notifications -->
        <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
          <div
            id="deleteToast"
            class="toast"
            role="alert"
            aria-live="assertive"
            aria-atomic="true"
          >
            <div class="toast-header bg-dark text-white">
              <i class="fas fa-info-circle me-2"></i>
              <strong class="me-auto">Notification</strong>
              <button
                type="button"
                class="btn-close btn-close-white"
                data-bs-dismiss="toast"
                aria-label="Close"
              ></button>
            </div>
            <div class="toast-body bg-dark text-white">
              <span id="toastMessage"></span>
            </div>
          </div>
        </div>

        <!-- Chapters Section -->
        <div id="chaptersSection" class="mt-5" style="display: none">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="dashboard-title mb-0">Chapters</h2>
            <div>
              <button
                class="btn btn-pink me-2"
                onclick="showAddChapterModal(currentLevelId)"
              >
                <i class="fas fa-plus me-2"></i>Add Chapter
              </button>
              <button class="btn btn-pink" onclick="hideChaptersSection()">
                <i class="fas fa-times me-2"></i>Close
              </button>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-dark table-hover">
              <thead>
                <tr>
                  <th style="width: 10%">Order</th>
                  <th style="width: 20%">Title</th>
                  <th style="width: 35%">Description</th>
                  <th style="width: 10%">XP</th>
                  <th style="width: 10%">Points</th>
                  <th style="width: 10%">Visit Count</th>
                  <th style="width: 10%">Win Rate</th>
                  <th style="width: 10%">Actions</th>
                </tr>
              </thead>
              <tbody id="chaptersList">
                <!-- Chapters will be loaded here dynamically -->
              </tbody>
            </table>
          </div>

          <!-- Lesson Content Section -->
          <div id="lessonContentSection" class="mt-4" style="display: none">
            <div class="d-flex justify-content-between align-items-center mb-4">
              <h3 class="dashboard-title mb-0">Lesson Content</h3>
              <div>
                <button
                  class="btn btn-pink me-2"
                  onclick="showAddLessonContentModal()"
                >
                  <i class="fas fa-plus me-2"></i>Add Page
                </button>
                <button
                  class="btn btn-pink"
                  onclick="hideLessonContentSection()"
                >
                  <i class="fas fa-times me-2"></i>Close
                </button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover">
                <thead>
                  <tr>
                    <th style="width: 5%">Page</th>
                    <th style="width: 15%">Title</th>
                    <th style="width: 10%">Type</th>
                    <th style="width: 30%">Content</th>
                    <th style="width: 10%">Visit Count</th>
                    <th style="width: 10%">Win Rate</th>
                    <th style="width: 15%">Actions</th>
                  </tr>
                </thead>
                <tbody id="lessonContentList">
                  <!-- Lesson content will be loaded here dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Edit Chapter Modal -->
        <div class="modal fade" id="editChapterModal" tabindex="-1">
          <div class="modal-dialog">
            <div
              class="modal-content"
              style="background: #2d145c; border: 2px solid #a259ff"
            >
              <div
                class="modal-header"
                style="background: #3a1464; color: #ff69b4"
              >
                <h5 class="modal-title">Edit Chapter</h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <form id="editChapterForm">
                  <input type="hidden" id="edit_chapter_id" name="chapter_id" />
                  <div class="mb-3">
                    <label
                      for="edit_name"
                      class="form-label"
                      style="color: #d3d3d3"
                      >Name</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="edit_name"
                      name="name"
                      required
                      style="
                        background: #240e44;
                        border: 1px solid #a259ff;
                        color: #fff;
                      "
                    />
                  </div>
                  <div class="mb-3">
                    <label
                      for="edit_title"
                      class="form-label"
                      style="color: #d3d3d3"
                      >Title</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="edit_title"
                      name="title"
                      required
                      style="
                        background: #240e44;
                        border: 1px solid #a259ff;
                        color: #fff;
                      "
                    />
                  </div>
                  <div class="mb-3">
                    <label
                      for="edit_description"
                      class="form-label"
                      style="color: #d3d3d3"
                      >Description</label
                    >
                    <textarea
                      class="form-control"
                      id="edit_description"
                      name="description"
                      rows="3"
                      required
                      style="
                        background: #240e44;
                        border: 1px solid #a259ff;
                        color: #fff;
                      "
                    ></textarea>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label
                        for="edit_xp_reward"
                        class="form-label"
                        style="color: #d3d3d3"
                        >XP Reward</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="edit_xp_reward"
                        name="xp_reward"
                        required
                        min="0"
                        style="
                          background: #240e44;
                          border: 1px solid #a259ff;
                          color: #fff;
                        "
                      />
                    </div>
                    <div class="col-md-6 mb-3">
                      <label
                        for="edit_points_reward"
                        class="form-label"
                        style="color: #d3d3d3"
                        >Points Reward</label
                      >
                      <input
                        type="number"
                        class="form-control"
                        id="edit_points_reward"
                        name="points_reward"
                        required
                        min="0"
                        style="
                          background: #240e44;
                          border: 1px solid #a259ff;
                          color: #fff;
                        "
                      />
                    </div>
                  </div>
                  <div class="mb-3">
                    <label
                      for="edit_order_num"
                      class="form-label"
                      style="color: #d3d3d3"
                      >Order Number</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="edit_order_num"
                      name="order_num"
                      required
                      min="1"
                      style="
                        background: #240e44;
                        border: 1px solid #a259ff;
                        color: #fff;
                      "
                    />
                  </div>
                  <div class="text-end">
                    <button
                      type="button"
                      class="btn btn-secondary me-2"
                      data-bs-dismiss="modal"
                    >
                      Cancel
                    </button>
                    <button type="submit" class="btn btn-pink">
                      Save Changes
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Level Modal -->
    <div class="modal fade" id="addLevelModal" tabindex="-1">
      <div class="modal-dialog">
        <div
          class="modal-content"
          style="background: #2d145c; border: 2px solid #a259ff"
        >
          <div class="modal-header" style="background: #3a1464; color: #ff69b4">
            <h5 class="modal-title">Add New Level</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form
              id="addLevelForm"
              method="POST"
              action="/admin/levels/add"
              enctype="multipart/form-data"
            >
              <div class="mb-3">
                <label for="title" class="form-label" style="color: #d3d3d3"
                  >Title</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="title"
                  name="title"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
              </div>
              <div class="mb-3">
                <label
                  for="description"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="description"
                  name="description"
                  rows="3"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                ></textarea>
              </div>
              <div class="mb-3">
                <label for="image_url" class="form-label" style="color: #d3d3d3"
                  >Level Logo Image</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="image_url"
                  name="image_url"
                  accept="image/*"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
              </div>
              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-secondary me-2"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-pink">Add Level</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Chapter Modal -->
    <div class="modal fade" id="addChapterModal" tabindex="-1">
      <div class="modal-dialog">
        <div
          class="modal-content"
          style="background: #2d145c; border: 2px solid #a259ff"
        >
          <div class="modal-header" style="background: #3a1464; color: #ff69b4">
            <h5 class="modal-title">Add New Chapter</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form
              id="addChapterForm"
              method="POST"
              action="/admin/chapters/add"
            >
              <input type="hidden" id="level_id" name="level_id" />
              <div class="mb-3">
                <label
                  for="chapter_name"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Name</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="chapter_name"
                  name="name"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                  placeholder="e.g., html-basics"
                />
              </div>
              <div class="mb-3">
                <label
                  for="chapter_title"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Title</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="chapter_title"
                  name="title"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                  placeholder="e.g., HTML Basics"
                />
              </div>
              <div class="mb-3">
                <label
                  for="chapter_description"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Description</label
                >
                <textarea
                  class="form-control"
                  id="chapter_description"
                  name="description"
                  rows="3"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                ></textarea>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label
                    for="xp_reward"
                    class="form-label"
                    style="color: #d3d3d3"
                    >XP Reward</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="xp_reward"
                    name="xp_reward"
                    required
                    style="
                      background: #240e44;
                      border: 1px solid #a259ff;
                      color: #fff;
                    "
                    min="0"
                    value="100"
                  />
                </div>
                <div class="col-md-6 mb-3">
                  <label
                    for="points_reward"
                    class="form-label"
                    style="color: #d3d3d3"
                    >Points Reward</label
                  >
                  <input
                    type="number"
                    class="form-control"
                    id="points_reward"
                    name="points_reward"
                    required
                    style="
                      background: #240e44;
                      border: 1px solid #a259ff;
                      color: #fff;
                    "
                    min="0"
                    value="50"
                  />
                </div>
              </div>
              <div class="mb-3">
                <label for="order_num" class="form-label" style="color: #d3d3d3"
                  >Order Number</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="order_num"
                  name="order_num"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                  min="1"
                  value="1"
                />
              </div>
              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-secondary me-2"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-pink">Add Chapter</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Lesson Content Modal -->
    <div class="modal fade" id="addLessonContentModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div
          class="modal-content"
          style="background: #2d145c; border: 2px solid #a259ff"
        >
          <div class="modal-header" style="background: #3a1464; color: #ff69b4">
            <h5 class="modal-title">Add Lesson Page</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="addLessonContentForm">
              <input
                type="hidden"
                id="add_lesson_chapter_id"
                name="chapter_id"
              />
              <!-- Page Type Selection -->
              <div class="mb-3">
                <label for="page_type" class="form-label" style="color: #d3d3d3"
                  >Page Type</label
                >
                <select
                  class="form-select"
                  id="page_type"
                  name="page_type"
                  required
                  onchange="updateFormFields()"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                >
                  <option value="text_image">Text and Image Only</option>
                  <option value="text_code">Text and Code Sample</option>
                  <option value="quiz">Question and Multiple Choices</option>
                  <option value="playground">Text and Code Playground</option>
                </select>
              </div>
              <div class="mb-3">
                <label
                  for="page_title"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Title</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="page_title"
                  name="title"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
              </div>
              <!-- Content Section -->
              <div class="mb-3">
                <label
                  for="page_content"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Content (HTML tags supported)</label
                >
                <textarea
                  class="form-control"
                  id="page_content"
                  name="content"
                  rows="4"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                ></textarea>
                <small class="text-muted"
                  >You can use HTML tags like &lt;h1&gt;, &lt;br&gt;, &lt;p&gt;,
                  etc.</small
                >
              </div>
              <!-- Image Section (for text_image type) -->
              <div id="image_section" class="mb-3">
                <label
                  for="image_file"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Image File</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="image_file"
                  name="image_file"
                  accept="image/*"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
                <small class="text-muted"
                  >Upload an image file (JPG, PNG, GIF)</small
                >
              </div>
              <!-- Code Example Section (for text_code type) -->
              <div id="code_section" class="mb-3" style="display: none">
                <label
                  for="code_example"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Code Example</label
                >
                <div id="admin-code-editor-container">
                  <textarea
                    class="form-control"
                    id="code_example"
                    name="code_example"
                    rows="4"
                  ></textarea>
                </div>
              </div>
              <!-- Multiple Choice Section (for quiz type) -->
              <div id="choices_section" class="mb-3" style="display: none">
                <label class="form-label" style="color: #d3d3d3">Choices</label>
                <div id="choices_list"></div>
                <button
                  type="button"
                  class="btn btn-sm btn-pink mt-2"
                  onclick="addChoiceField()"
                >
                  <i class="fas fa-plus"></i> Add Choice
                </button>
              </div>
              <!-- Quiz Feedback Messages -->
              <div
                id="quiz_feedback_section"
                class="mb-3"
                style="display: none"
              >
                <div class="mb-3">
                  <label
                    for="correct_message"
                    class="form-label"
                    style="color: #d3d3d3"
                    >Correct Answer Message</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="correct_message"
                    name="correct_message"
                    placeholder="e.g., Great job! That's correct!"
                    style="
                      background: #240e44;
                      border: 1px solid #a259ff;
                      color: #fff;
                    "
                  />
                </div>
              </div>
              <!-- Notes Section (for all page types) -->
              <div class="mb-3">
                <label for="notes" class="form-label" style="color: #d3d3d3"
                  >Notes (Optional)</label
                >
                <textarea
                  class="form-control"
                  id="notes"
                  name="notes"
                  rows="2"
                  placeholder="Add any additional notes or instructions"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                ></textarea>
              </div>
              <!-- Next Button Text -->
              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-secondary me-2"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-pink">Add Page</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Lesson Content Modal -->
    <div class="modal fade" id="editLessonContentModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div
          class="modal-content"
          style="background: #2d145c; border: 2px solid #a259ff"
        >
          <div class="modal-header" style="background: #3a1464; color: #ff69b4">
            <h5 class="modal-title">Edit Lesson Page</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="editLessonContentForm">
              <input type="hidden" id="edit_lesson_id" name="id" />
              <input
                type="hidden"
                id="edit_lesson_chapter_id"
                name="chapter_id"
              />

              <!-- Page Type Selection -->
              <div class="mb-3">
                <label
                  for="edit_page_type"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Page Type</label
                >
                <select
                  class="form-select"
                  id="edit_page_type"
                  name="page_type"
                  required
                  onchange="updateEditFormFields()"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                >
                  <option value="text_image">Text and Image Only</option>
                  <option value="text_code">Text and Code Sample</option>
                  <option value="quiz">Question and Multiple Choices</option>
                  <option value="playground">Text and Code Playground</option>
                </select>
              </div>

              <div class="mb-3">
                <label
                  for="edit_page_num"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Page Number</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="edit_page_num"
                  name="page_num"
                  required
                  min="1"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
              </div>
              <div class="mb-3">
                <label
                  for="edit_page_title"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Title</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit_page_title"
                  name="title"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
              </div>
              <div class="mb-3">
                <label
                  for="edit_page_content"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Content (HTML tags supported)</label
                >
                <textarea
                  class="form-control"
                  id="edit_page_content"
                  name="content"
                  rows="4"
                  required
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                ></textarea>
                <small class="text-muted"
                  >You can use HTML tags like &lt;h1&gt;, &lt;br&gt;, &lt;p&gt;,
                  etc.</small
                >
              </div>

              <!-- Image Section (for text_image type) -->
              <div id="edit_image_section" class="mb-3">
                <label
                  for="edit_image_file"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Image File</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="edit_image_file"
                  name="image_file"
                  accept="image/*"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
                <small class="text-muted"
                  >Upload a new image file (JPG, PNG, GIF) or leave empty to
                  keep current image</small
                >
                <div
                  id="current_image_preview"
                  class="mt-2"
                  style="display: none"
                >
                  <p class="text-muted">Current Image:</p>
                  <img
                    id="current_image"
                    src=""
                    alt="Current image"
                    style="max-width: 200px; max-height: 200px"
                  />
                </div>
              </div>

              <!-- Code Example Section (for text_code type) -->
              <div id="edit_code_section" class="mb-3" style="display: none">
                <label
                  for="edit_code_example"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Code Example</label
                >
                <div id="admin-code-editor-container">
                  <textarea
                    class="form-control"
                    id="edit_code_example"
                    name="code_example"
                    rows="4"
                  ></textarea>
                </div>
              </div>

              <!-- Multiple Choice Section (for quiz type) -->
              <div id="edit_choices_section" class="mb-3" style="display: none">
                <label class="form-label" style="color: #d3d3d3">Choices</label>
                <div id="edit_choices_list"></div>
                <button
                  type="button"
                  class="btn btn-sm btn-pink mt-2"
                  onclick="addEditChoiceField()"
                >
                  <i class="fas fa-plus"></i> Add Choice
                </button>
              </div>

              <!-- Edit Quiz Feedback Messages -->
              <div
                id="edit_quiz_feedback_section"
                class="mb-3"
                style="display: none"
              >
                <div class="mb-3">
                  <label
                    for="edit_correct_message"
                    class="form-label"
                    style="color: #d3d3d3"
                    >Correct Answer Message</label
                  >
                  <input
                    type="text"
                    class="form-control"
                    id="edit_correct_message"
                    name="correct_message"
                    placeholder="e.g., Great job! That's correct!"
                    style="
                      background: #240e44;
                      border: 1px solid #a259ff;
                      color: #fff;
                    "
                  />
                </div>
              </div>

              <!-- Edit Notes Section -->
              <div class="mb-3">
                <label
                  for="edit_notes"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Notes (Optional)</label
                >
                <textarea
                  class="form-control"
                  id="edit_notes"
                  name="notes"
                  rows="2"
                  placeholder="Add any additional notes or instructions"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                ></textarea>
              </div>

              <div class="mb-3">
                <label
                  for="edit_next_button_text"
                  class="form-label"
                  style="color: #d3d3d3"
                  >Next Button Text</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="edit_next_button_text"
                  name="next_button_text"
                  style="
                    background: #240e44;
                    border: 1px solid #a259ff;
                    color: #fff;
                  "
                />
              </div>
              <div class="text-end">
                <button
                  type="button"
                  class="btn btn-secondary me-2"
                  data-bs-dismiss="modal"
                >
                  Cancel
                </button>
                <button type="submit" class="btn btn-pink">Update Page</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Handle Add Level Form Submission
      document
        .getElementById("addLevelForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(this);

          fetch("/admin/levels/add", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Close modal and refresh page
                bootstrap.Modal.getInstance(
                  document.getElementById("addLevelModal")
                ).hide();
                window.location.reload();
              } else {
                alert(data.message || "Failed to add level");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while adding the level");
            });
        });

      // Handle Add Chapter Form Submission
      document
        .getElementById("addChapterForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(this);

          // Debug: Log all form data to console
          console.log("Form data being submitted:");
          for (let [key, value] of formData.entries()) {
            console.log(key + ": " + value);
          }

          fetch("/admin/chapters/add", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Close modal and refresh chapters list
                bootstrap.Modal.getInstance(
                  document.getElementById("addChapterModal")
                ).hide();
                showChaptersList(document.getElementById("level_id").value);
              } else {
                alert(data.message || "Failed to add chapter");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              alert("An error occurred while adding the chapter");
            });
        });

      function showAddChapterModal(levelId) {
        // Ensure level_id is properly set in the hidden input
        const levelIdInput = document.getElementById("level_id");
        levelIdInput.value = levelId;
        console.log("Setting level_id to:", levelId); // Debug log
        new bootstrap.Modal(document.getElementById("addChapterModal")).show();
      }

      // Store analytics data globally for current level
      let currentLevelAnalytics = [];
      let currentLevelId = null; // Store current level ID

      function showChaptersList(levelId) {
        currentLevelId = levelId; // Store the current level ID
        // Fetch chapters and analytics in parallel
        Promise.all([
          fetch(`/admin/chapters/${levelId}`).then((r) => r.json()),
          fetch(`/admin/levels/${levelId}/analytics`).then((r) => r.json()),
        ]).then(([chapters, analyticsResp]) => {
          if (!analyticsResp.success) {
            alert("Failed to load analytics: " + analyticsResp.message);
            return;
          }
          currentLevelAnalytics = analyticsResp.analytics || [];
          const chapterSummary = analyticsResp.chapter_summary || {};

          // Group analytics by page for lesson content
          const analyticsByPage = {};
          for (const row of currentLevelAnalytics) {
            const pageKey = `${row.chapter_id}_${row.page_num}`;
            analyticsByPage[pageKey] = row;
          }

          // Render chapters table
          const tbody = document.getElementById("chaptersList");
          tbody.innerHTML = "";
          chapters.forEach((chapter) => {
            const chapterData = chapterSummary[chapter.id] || {};
            const uniqueUsers = chapterData.unique_users || 0;
            const totalPageVisits = chapterData.total_page_visits || 0;
            const totalIncorrect = chapterData.total_incorrect || 0;

            // Win rate: 1 - (total incorrect / total visits)
            let winRate = "-";
            if (totalPageVisits > 0) {
              winRate =
                ((1 - totalIncorrect / totalPageVisits) * 100).toFixed(1) + "%";
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${chapter.order_num}</td>
              <td>${chapter.title}</td>
              <td>${chapter.description}</td>
              <td>${chapter.xp_reward}</td>
              <td>${chapter.points_reward}</td>
              <td>${uniqueUsers}</td>
              <td>${winRate}</td>
              <td>
                <div class="btn-group">
                  <button class="btn btn-sm btn-pink" onclick="editChapter(${chapter.id})">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn btn-sm btn-pink" onclick="showLessonContentSection(${chapter.id})">
                    <i class="fas fa-book"></i>
                  </button>
                  <button class="btn btn-sm btn-pink" onclick="deleteChapter(${chapter.id})">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            `;
            tbody.appendChild(tr);
          });
          // Show chapters section
          document.getElementById("chaptersSection").style.display = "";
          // Hide lesson content section
          document.getElementById("lessonContentSection").style.display =
            "none";
          // Store analytics for use in lesson content
          window._analyticsByPage = analyticsByPage;
        });
      }

      function stripHtml(html) {
        let div = document.createElement("div");
        div.innerHTML = html;
        return div.textContent || div.innerText || "";
      }

      // Track the current chapter for adding/deleting lesson content
      let currentLessonChapterId = null;

      function showLessonContentSection(chapterId) {
        currentLessonChapterId = chapterId;
        // Set the chapter_id for the Add Page modal
        document.getElementById("add_lesson_chapter_id").value = chapterId;
        // Fetch lesson content for chapter
        fetch(`/admin/lesson-content/${chapterId}`)
          .then((r) => r.json())
          .then((pages) => {
            const tbody = document.getElementById("lessonContentList");
            tbody.innerHTML = "";
            // Use analyticsByPage from global
            const analyticsByPage = window._analyticsByPage || {};
            pages.forEach((page) => {
              const analytics =
                analyticsByPage[`${chapterId}_${page.page_num}`] || {};
              const visitCount = analytics.total_visits || 0;
              let winRate = "-";
              if (visitCount > 0) {
                winRate =
                  (
                    (1 - Number(analytics.total_incorrect || 0) / visitCount) *
                    100
                  ).toFixed(1) + "%";
              }
              const contentPreview =
                stripHtml(page.content || "").slice(0, 60) +
                (page.content && stripHtml(page.content).length > 60
                  ? "..."
                  : "");
              const tr = document.createElement("tr");
              tr.innerHTML = `
                <td>${page.page_num}</td>
                <td>${page.title || ""}</td>
                <td>${page.page_type || ""}</td>
                <td>${contentPreview}</td>
                <td>${visitCount}</td>
                <td>${winRate}</td>
                <td>
                  <div class="btn-group">
                    <button class="btn btn-sm btn-pink" onclick="editLessonContent(${
                      page.id
                    })"><i class="fas fa-edit"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLessonContent(${
                      page.id
                    }, ${chapterId})"><i class="fas fa-trash"></i></button>
                  </div>
                </td>
              `;
              tbody.appendChild(tr);
            });
            document.getElementById("lessonContentSection").style.display = "";
          });
      }

      function hideLessonContentSection() {
        document.getElementById("lessonContentSection").style.display = "none";
      }

      function showAddLessonContentModal() {
        // Ensure the chapter_id is set before showing the modal
        if (currentLessonChapterId) {
          document.getElementById("add_lesson_chapter_id").value =
            currentLessonChapterId;
        }
        new bootstrap.Modal(
          document.getElementById("addLessonContentModal")
        ).show();
      }

      // Handle Add Lesson Content Form Submission
      document
        .getElementById("addLessonContentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Sync CodeMirror value before creating FormData
          if (adminCodeMirrorInstance) {
            document.getElementById("code_example").value =
              adminCodeMirrorInstance.getValue();
          }

          const formData = new FormData(this);
          const chapterId = formData.get("chapter_id");

          fetch("/admin/lesson-content/add", {
            method: "POST",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(
                  document.getElementById("addLessonContentModal")
                ).hide();
                // Show success message
                showToast("Lesson page added successfully");
                // Refresh the lesson content list
                showLessonContent(chapterId);
              } else {
                showToast(data.message || "Failed to add lesson page", "error");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast(
                "An error occurred while adding the lesson page",
                "error"
              );
            });
        });

      function editLessonContent(pageId) {
        // Fetch lesson content details
        fetch(`/admin/lesson-content/${pageId}/edit`)
          .then((response) => response.json())
          .then((page) => {
            // Populate the edit form
            document.getElementById("edit_lesson_id").value = page.id;
            document.getElementById("edit_page_num").value = page.page_num;
            document.getElementById("edit_page_title").value = page.title;
            document.getElementById("edit_page_content").value = page.content;
            document.getElementById("edit_code_example").value =
              page.code_example || "";
            document.getElementById("edit_next_button_text").value =
              page.next_button_text || "Next";
            document.getElementById("edit_page_type").value =
              page.page_type || "text_image";
            document.getElementById("edit_notes").value = page.notes || "";
            document.getElementById("edit_correct_message").value =
              page.correct_message || "";

            // Handle image preview
            const currentImagePreview = document.getElementById(
              "current_image_preview"
            );
            const currentImage = document.getElementById("current_image");
            if (page.image_url) {
              currentImage.src = page.image_url;
              currentImagePreview.style.display = "block";
            } else {
              currentImagePreview.style.display = "none";
            }

            // Update form fields based on page type
            updateEditFormFields();

            // Populate choices if quiz
            const editChoicesSection = document.getElementById(
              "edit_choices_section"
            );
            const editChoicesList =
              document.getElementById("edit_choices_list");
            editChoicesList.innerHTML = "";
            if (page.page_type === "quiz" && page.choices) {
              page.choices.forEach((choice, idx) => {
                addEditChoiceField(choice.choice_text, !!choice.is_correct);
              });
              editChoicesSection.style.display = "block";
            }

            // Show the modal
            new bootstrap.Modal(
              document.getElementById("editLessonContentModal")
            ).show();
          })
          .catch((error) => {
            console.error("Error:", error);
            showToast(
              "An error occurred while fetching lesson page details",
              "error"
            );
          });
      }

      // Handle Edit Lesson Content Form Submission
      document
        .getElementById("editLessonContentForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          // Sync CodeMirror value before creating FormData
          if (adminEditCodeMirrorInstance) {
            document.getElementById("edit_code_example").value =
              adminEditCodeMirrorInstance.getValue();
          }

          const formData = new FormData(this);
          const pageId = formData.get("id");
          const chapterId = formData.get("chapter_id");

          fetch(`/admin/lesson-content/${pageId}`, {
            method: "PUT",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(
                  document.getElementById("editLessonContentModal")
                ).hide();
                // Show success message
                showToast("Lesson page updated successfully");
                // Refresh the lesson content list
                showLessonContent(chapterId);
              } else {
                showToast(
                  data.message || "Failed to update lesson page",
                  "error"
                );
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast(
                "An error occurred while updating the lesson page",
                "error"
              );
            });
        });

      function deleteLessonContent(pageId, chapterId) {
        if (confirm("Are you sure you want to delete this lesson page?")) {
          fetch(`/admin/lesson-content/${pageId}`, {
            method: "DELETE",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                showToast("Lesson page deleted successfully");
                showLessonContentSection(chapterId);
              } else {
                showToast(
                  data.message || "Failed to delete lesson page",
                  "error"
                );
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast(
                "An error occurred while deleting the lesson page",
                "error"
              );
            });
        }
      }

      function hideChaptersSection() {
        document.getElementById("chaptersSection").style.display = "none";
      }

      function editChapter(chapterId) {
        // Fetch chapter details
        fetch(`/admin/chapters/${chapterId}/edit`)
          .then((response) => response.json())
          .then((chapter) => {
            // Populate the edit form
            document.getElementById("edit_chapter_id").value = chapter.id;
            document.getElementById("edit_name").value = chapter.name;
            document.getElementById("edit_title").value = chapter.title;
            document.getElementById("edit_description").value =
              chapter.description;
            document.getElementById("edit_xp_reward").value = chapter.xp_reward;
            document.getElementById("edit_points_reward").value =
              chapter.points_reward;
            document.getElementById("edit_order_num").value = chapter.order_num;

            // Show the modal
            new bootstrap.Modal(
              document.getElementById("editChapterModal")
            ).show();
          })
          .catch((error) => {
            console.error("Error:", error);
            showToast(
              "An error occurred while fetching chapter details",
              "error"
            );
          });
      }

      // Handle edit form submission
      document
        .getElementById("editChapterForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const formData = new FormData(this);
          const chapterId = formData.get("chapter_id");
          const levelId = document.getElementById("level_id").value;

          fetch(`/admin/chapters/${chapterId}`, {
            method: "PUT",
            body: formData,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(
                  document.getElementById("editChapterModal")
                ).hide();
                // Show success message
                showToast("Chapter updated successfully");
                // Refresh the chapters list
                showChaptersList(levelId);
              } else {
                showToast(data.message || "Failed to update chapter", "error");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast(
                "An error occurred while updating the chapter",
                "error"
              );
            });
        });

      function showToast(message, type = "success") {
        const toast = document.getElementById("deleteToast");
        const toastMessage = document.getElementById("toastMessage");
        toastMessage.textContent = message;
        toast.classList.remove("bg-success", "bg-danger");
        toast.classList.add(type === "success" ? "bg-success" : "bg-danger");
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
      }

      function deleteChapter(chapterId) {
        if (confirm("Are you sure you want to delete this chapter?")) {
          fetch(`/admin/chapters/${chapterId}`, {
            method: "DELETE",
          })
            .then((response) => response.json())
            .then((data) => {
              // Update the chapter count immediately
              const levelId = document.getElementById("level_id").value;
              const chapterCountElement = document.querySelector(
                `.chapter-count-${levelId}`
              );
              const currentCount = parseInt(chapterCountElement.textContent);
              chapterCountElement.textContent = currentCount - 1;

              // Show success message
              showToast("Chapter deleted successfully");

              // Refresh the chapters list
              showChaptersList(levelId);
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast(
                "An error occurred while deleting the chapter",
                "error"
              );
            });
        }
      }

      function deleteLevel(levelId) {
        if (
          confirm(
            "Are you sure you want to delete this level? This will also delete all associated chapters."
          )
        ) {
          fetch(`/admin/levels/${levelId}`, {
            method: "DELETE",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                // Find and remove the level card with animation
                const levelCard = document.querySelector(
                  `[data-level-id="${levelId}"]`
                );
                if (levelCard) {
                  // Add fade-out animation
                  levelCard.style.transition = "all 0.3s ease-out";
                  levelCard.style.opacity = "0";
                  levelCard.style.transform = "scale(0.95)";

                  // Remove the element after animation
                  setTimeout(() => {
                    levelCard.remove();
                    // Show success message
                    showToast("Level deleted successfully");
                  }, 300);
                }

                // Hide chapters section if it's showing
                hideChaptersSection();
              } else {
                showToast(data.message || "Failed to delete level", "error");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              showToast("An error occurred while deleting the level", "error");
            });
        }
      }

      // Function to update form fields based on page type
      function updateFormFields() {
        const pageType = document.getElementById("page_type").value;
        const imageSection = document.getElementById("image_section");
        const codeSection = document.getElementById("code_section");
        const choicesSection = document.getElementById("choices_section");
        const quizFeedbackSection = document.getElementById(
          "quiz_feedback_section"
        );

        // Reset all sections
        imageSection.style.display = "none";
        codeSection.style.display = "none";
        choicesSection.style.display = "none";
        quizFeedbackSection.style.display = "none";

        // Show relevant sections based on page type
        switch (pageType) {
          case "text_image":
            imageSection.style.display = "block";
            break;
          case "text_code":
            codeSection.style.display = "block";
            break;
          case "quiz":
            choicesSection.style.display = "block";
            quizFeedbackSection.style.display = "block";
            break;
          case "playground":
            codeSection.style.display = "block";
            break;
        }
      }

      // Add/Remove choice fields for multiple choice
      function renumberChoiceFields(listId, inputPrefix = "choice_text_") {
        const choicesList = document.getElementById(listId);
        const choiceDivs = Array.from(choicesList.children);
        choiceDivs.forEach((div, idx) => {
          // Update radio value and name
          const radio = div.querySelector('input[type="radio"]');
          if (radio) radio.value = idx;
          // Update text input name
          const textInput = div.querySelector('input[type="text"]');
          if (textInput) textInput.name = inputPrefix + idx;
        });
      }
      // Update addChoiceField to call renumber after delete
      function addChoiceField(value = "", isCorrect = false) {
        const choicesList = document.getElementById("choices_list");
        const idx = choicesList.children.length;
        const choiceDiv = document.createElement("div");
        choiceDiv.className = "input-group mb-2";
        choiceDiv.innerHTML = `
          <div class="input-group-text">
            <input type="radio" name="correct_choice" value="${idx}" ${
          isCorrect ? "checked" : ""
        } title="Mark as correct" />
          </div>
          <input type="text" class="form-control" name="choice_text_${idx}" value="${value}" placeholder="Choice text" required />
          <button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); renumberChoiceFields('choices_list');"><i class="fas fa-trash"></i></button>
        `;
        choicesList.appendChild(choiceDiv);
      }

      // Reset choices when modal is shown
      const addLessonContentModal = document.getElementById(
        "addLessonContentModal"
      );
      addLessonContentModal.addEventListener("show.bs.modal", function () {
        updateFormFields();
        document.getElementById("choices_list").innerHTML = "";
        // Only add default choices if the current type is quiz
        if (document.getElementById("page_type").value === "quiz") {
          addChoiceField();
          addChoiceField();
        }
      });

      // Function to update edit form fields based on page type
      function updateEditFormFields() {
        const pageType = document.getElementById("edit_page_type").value;
        const imageSection = document.getElementById("edit_image_section");
        const codeSection = document.getElementById("edit_code_section");
        const choicesSection = document.getElementById("edit_choices_section");
        const quizFeedbackSection = document.getElementById(
          "edit_quiz_feedback_section"
        );

        // Reset all sections
        imageSection.style.display = "none";
        codeSection.style.display = "none";
        choicesSection.style.display = "none";
        quizFeedbackSection.style.display = "none";

        // Show relevant sections based on page type
        switch (pageType) {
          case "text_image":
            imageSection.style.display = "block";
            break;
          case "text_code":
            codeSection.style.display = "block";
            break;
          case "quiz":
            choicesSection.style.display = "block";
            quizFeedbackSection.style.display = "block";
            break;
          case "playground":
            codeSection.style.display = "block";
            break;
        }
      }

      // Call updateEditFormFields when the edit modal is shown
      document
        .getElementById("editLessonContentModal")
        .addEventListener("show.bs.modal", function () {
          updateEditFormFields();
        });

      // Update addEditChoiceField to call renumber after delete
      function addEditChoiceField(value = "", isCorrect = false) {
        const choicesList = document.getElementById("edit_choices_list");
        const idx = choicesList.children.length;
        const choiceDiv = document.createElement("div");
        choiceDiv.className = "input-group mb-2";
        choiceDiv.innerHTML = `
          <div class="input-group-text">
            <input type="radio" name="correct_choice" value="${idx}" ${
          isCorrect ? "checked" : ""
        } title="Mark as correct" />
          </div>
          <input type="text" class="form-control" name="choice_text_${idx}" value="${value}" placeholder="Choice text" required />
          <button type="button" class="btn btn-danger" onclick="this.parentElement.remove(); renumberChoiceFields('edit_choices_list');"><i class="fas fa-trash"></i></button>
        `;
        choicesList.appendChild(choiceDiv);
      }

      // Add CodeMirror for both add and edit modals
      let adminCodeMirrorInstance = null;
      let adminEditCodeMirrorInstance = null;

      function initializeAdminCodeEditor() {
        const textarea = document.getElementById("code_example");
        if (textarea && !adminCodeMirrorInstance) {
          adminCodeMirrorInstance = CodeMirror.fromTextArea(textarea, {
            mode: "htmlmixed",
            theme: "material-darker",
            lineNumbers: true,
            autoCloseBrackets: true,
            autoCloseTags: true,
            matchBrackets: true,
            styleActiveLine: true,
            lineWrapping: true,
            tabSize: 2,
            indentWithTabs: false,
            extraKeys: {
              "Ctrl-Space": "autocomplete",
              Tab: function (cm) {
                if (cm.somethingSelected()) {
                  cm.indentSelection("add");
                } else {
                  cm.replaceSelection("  ", "end");
                }
              },
              Enter: "newlineAndIndent",
            },
          });
          adminCodeMirrorInstance.setSize("100%", "180px");
        }
      }

      function initializeAdminEditCodeEditor() {
        const textarea = document.getElementById("edit_code_example");
        if (textarea && !adminEditCodeMirrorInstance) {
          adminEditCodeMirrorInstance = CodeMirror.fromTextArea(textarea, {
            mode: "htmlmixed",
            theme: "material-darker",
            lineNumbers: true,
            autoCloseBrackets: true,
            autoCloseTags: true,
            matchBrackets: true,
            styleActiveLine: true,
            lineWrapping: true,
            tabSize: 2,
            indentWithTabs: false,
            extraKeys: {
              "Ctrl-Space": "autocomplete",
              Tab: function (cm) {
                if (cm.somethingSelected()) {
                  cm.indentSelection("add");
                } else {
                  cm.replaceSelection("  ", "end");
                }
              },
              Enter: "newlineAndIndent",
            },
          });
          adminEditCodeMirrorInstance.setSize("100%", "180px");
        }
      }

      // Show CodeMirror when code section is visible (add modal)
      function showCodeSectionIfNeeded() {
        const codeSection = document.getElementById("code_section");
        if (codeSection && codeSection.style.display !== "none") {
          initializeAdminCodeEditor();
        }
      }
      // Show CodeMirror when edit code section is visible (edit modal)
      function showEditCodeSectionIfNeeded() {
        const codeSection = document.getElementById("edit_code_section");
        if (codeSection && codeSection.style.display !== "none") {
          initializeAdminEditCodeEditor();
        }
      }
      window.addEventListener("DOMContentLoaded", showCodeSectionIfNeeded);
      document
        .getElementById("page_type")
        .addEventListener("change", showCodeSectionIfNeeded);
      // For edit modal, listen for modal show event and page type change
      const editLessonContentModal = document.getElementById(
        "editLessonContentModal"
      );
      if (editLessonContentModal) {
        editLessonContentModal.addEventListener(
          "shown.bs.modal",
          showEditCodeSectionIfNeeded
        );
        document
          .getElementById("edit_page_type")
          .addEventListener("change", showEditCodeSectionIfNeeded);
      }
      // On form submit, sync CodeMirror content to textarea
      const addLessonContentForm = document.getElementById(
        "addLessonContentForm"
      );
      if (addLessonContentForm) {
        addLessonContentForm.addEventListener("submit", function (e) {
          if (adminCodeMirrorInstance) {
            document.getElementById("code_example").value =
              adminCodeMirrorInstance.getValue();
          }
        });
      }
      const editLessonContentForm = document.getElementById(
        "editLessonContentForm"
      );
      if (editLessonContentForm) {
        editLessonContentForm.addEventListener("submit", function (e) {
          if (adminEditCodeMirrorInstance) {
            document.getElementById("edit_code_example").value =
              adminEditCodeMirrorInstance.getValue();
          }
        });
      }

      // Add this helper function at the top of the script block if not present:
      function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"']/g, function (c) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[c];
        });
      }

      // Restore showLessonContent for refresh after edit
      function showLessonContent(chapterId) {
        showLessonContentSection(chapterId);
      }
    </script>
    <style>
      #admin-code-editor-container .CodeMirror {
        font-size: 1rem;
        border-radius: 6px;
        background: #19182c;
        color: #fff;
        border: 1px solid #39386b;
        margin-bottom: 6px;
        min-height: 120px;
        max-height: 200px;
      }
      #admin-code-editor-container .CodeMirror-focused {
        border-color: #7e31ef;
        box-shadow: 0 0 0 1.5px #7e31ef;
      }
    </style>
  </body>
</html>
