<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Code Playground | WebScape</title>
    <link
      rel="icon"
      href="/static/images/playground-mode.png"
      type="image/png"
    />
    <!-- CodeMirror CSS -->
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/dracula.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/lint.css"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.css"
      rel="stylesheet"
    />

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&display=swap"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap");

      :root {
        --bg-color: #240e44;
        --secondary-color: #371569;
        --accent-color: #ff66c4;
        --sidebar-bg: #371569;
        --card-bg: #371569;
        --accent: #ff66c4;
        --accent-hover: #c54fa3;
        --text-main: #eaeaea;
        --text-muted: #b3b3b3;
        --border-radius: 8px;
        --transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        --bright-purple: #7e31ef;
      }

      * {
        box-sizing: border-box;
        list-style-type: none;
        padding: 0;
        margin: 0;
        text-decoration: none !important;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: var(--bg-color);
        color: #a9a9a9;
        font-family: "Montserrat", sans-serif;
        overflow: hidden;
      }

      .sidebar {
        background-color: #3a1464;
        width: 90px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        gap: 50px;
      }
      .sidebar .nav-item {
        text-align: center;
        font-weight: 500;
        font-size: 14px;
        color: #a9a9a9;
        -webkit-user-select: none;
        user-select: none;
      }
      .sidebar .nav-item i {
        font-size: 28px;
        display: block;
        margin-bottom: 6px;
        color: #a9a9a9;
      }
      .sidebar .nav-item.badges i {
        color: #bfbfbf;
      }
      .sidebar .nav-item.account i {
        font-size: 32px;
        color: #bfbfbf;
      }
      .sidebar .nav-item:hover {
        color: #ff69b4;
      }
      .sidebar .nav-item:hover i {
        color: #ff69b4;
      }

      .playground {
        margin-left: 90px;
        padding: 20px;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .section-title,
      .section-title a {
        color: white;
        font-family: "Luckiest Guy", cursive;
        font-size: 24px;
        margin-bottom: 10px;
        text-decoration: none;

        &:hover {
          color: var(--accent-color);
        }
      }

      .tabs {
        display: flex;
        background-color: var(--secondary-color);
        border-radius: 10px 10px 0 0;
      }

      .tab {
        padding: 10px 20px;
        cursor: pointer;
        color: #fff;
        font-weight: bold;
        border-bottom: 3px solid transparent;
      }

      .tab.active {
        color: var(--accent-color);
        border-bottom: 3px solid var(--accent-color);
      }

      .editor-container {
        display: flex;
        flex: 1;
        background-color: #1e1e1e;
        border-radius: 0 0 10px 10px;
        overflow: hidden;
        position: relative;
      }

      .editor,
      .live-output {
        width: 50%;
        height: 100%;
      }

      .editor {
        overflow-y: auto;
      }

      .live-output {
        background: #0f0f13;
        color: #f5f5f5;
        display: flex;
        flex-direction: column;
        border-left: 1px solid rgba(255, 255, 255, 0.05);
        overflow: hidden;
      }

      .live-output iframe {
        flex: 1 1 auto;
        width: 100%;
        border: none;
        background: #ffffff;
      }

      .debug-panel {
        display: flex;
        flex-direction: column;
        background: rgba(17, 17, 26, 0.9);
        border-top: 1px solid rgba(162, 89, 255, 0.35);
        max-height: 40%;
        min-height: 140px;
      }

      .debug-panel.collapsed {
        min-height: 0;
      }

      .debug-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px 14px;
        background: rgba(55, 21, 105, 0.6);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        font-size: 0.9rem;
        letter-spacing: 0.02em;
      }

      .debug-panel-header span {
        font-weight: 600;
        color: #f5f5f5;
      }

      .debug-panel-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .debug-clear-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: #f5f5f5;
        font-size: 0.75rem;
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
      }

      .debug-clear-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.4);
        color: #ffffff;
      }

      .debug-toggle-btn {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: #f5f5f5;
        width: 32px;
        height: 28px;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
      }

      .debug-toggle-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.4);
        color: #ffffff;
      }

      .debug-panel-body {
        flex: 1 1 auto;
        padding: 12px 14px;
        overflow-y: auto;
        font-family: "Fira Code", monospace;
        font-size: 0.85rem;
        background: rgba(12, 12, 20, 0.65);
      }

      .debug-panel-body::-webkit-scrollbar {
        width: 6px;
      }

      .debug-panel-body::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.2);
        border-radius: 3px;
      }

      .debug-panel.collapsed .debug-panel-body {
        display: none;
      }

      .debug-placeholder {
        color: #8a8a8a;
        font-size: 0.85rem;
      }

      .debug-entry {
        margin-bottom: 10px;
        color: #f5f5f5;
        line-height: 1.45;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .debug-entry:last-child {
        margin-bottom: 0;
      }

      .debug-entry-time {
        color: rgba(255, 255, 255, 0.45);
        font-size: 0.75rem;
        margin-right: 8px;
      }

      .debug-entry-text {
        color: inherit;
      }

      .debug-entry-stack {
        margin-top: 6px;
        padding-left: 18px;
        border-left: 2px solid rgba(255, 255, 255, 0.15);
        font-size: 0.78rem;
        color: rgba(255, 255, 255, 0.75);
        white-space: pre-wrap;
      }

      .debug-entry.debug-log .debug-entry-text {
        color: #c9c9c9;
      }

      .debug-entry.debug-info .debug-entry-text {
        color: #9ad5ff;
      }

      .debug-entry.debug-warn .debug-entry-text {
        color: #ffd166;
      }

      .debug-entry.debug-error .debug-entry-text {
        color: #ff6b6b;
      }

      .debug-entry.debug-debug .debug-entry-text {
        color: #76baff;
      }

      .code-editor {
        display: none;
        height: 100%;
      }

      .code-editor.active {
        display: block;
      }

      .CodeMirror {
        height: 100%;
        font-family: "Fira Code", monospace;
        font-size: 14px;
        line-height: 1.6;
      }

      .CodeMirror-gutters {
        border-right: 1px solid #3a1464;
        background-color: #2c2c2c;
      }

      .CodeMirror-linenumber {
        color: #888;
      }

      .CodeMirror-cursor {
        border-left: 2px solid var(--accent-color);
      }

      .CodeMirror-selected {
        background-color: rgba(255, 102, 196, 0.2);
      }

      .CodeMirror-focused .CodeMirror-selected {
        background-color: rgba(255, 102, 196, 0.3);
      }

      .CodeMirror-matchingbracket {
        color: var(--accent-color) !important;
        font-weight: bold;
      }

      .CodeMirror-matchingtag {
        background-color: rgba(255, 102, 196, 0.1);
      }

      .CodeMirror-hints {
        background-color: #2c2c2c;
        border: 1px solid #3a1464;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      .CodeMirror-hint {
        color: #fff;
        padding: 4px 8px;
      }

      .CodeMirror-hint-active {
        background-color: var(--accent-color);
        color: #fff;
      }

      .tabs-container {
        display: flex;
        justify-content: space-between;
        background-color: var(--secondary-color);
        align-items: center;
        padding: 0 20px;
      }
      .live-output-label {
        font-size: 16px;
        color: #fff;
        padding: 10px;
      }

      /* Loading State */
      .editor-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-color);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .loader {
        width: 48px;
        height: 48px;
        border: 5px solid var(--accent-color);
        border-bottom-color: transparent;
        border-radius: 50%;
        display: inline-block;
        box-sizing: border-box;
        animation: rotation 1s linear infinite;
      }

      @keyframes rotation {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* AI Code Fix Styles */
      .ai-fix-btn {
        background-color: transparent;
        color: var(--accent-color);
        border: none;
        padding: 8px 16px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: bold;
        transition: all 0.3s ease;
        margin-left: 20px;
        font-size: 12px;
      }

      .ai-fix-btn:hover {
        color: #fff;
        text-shadow: 0 0 5px var(--accent-color);
      }

      .ai-fix-btn i {
        font-size: 16px;
      }

      /* Modal Styles */
      .ai-response {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: var(--secondary-color);
        padding: 30px;
        border-radius: 15px;
        max-width: 600px;
        width: 90%;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        z-index: 1000;
      }

      .ai-response.show {
        display: block;
      }

      .ai-response-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid var(--accent-color);
      }

      .ai-response-title {
        color: var(--accent-color);
        font-weight: bold;
        font-size: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .ai-response-close {
        background: none;
        border: none;
        color: #fff;
        cursor: pointer;
        font-size: 24px;
        padding: 0;
        transition: color 0.3s ease;
      }

      .ai-response-close:hover {
        color: var(--accent-color);
      }

      .ai-response-content {
        color: #fff;
        line-height: 1.6;
        font-size: 16px;
        max-height: 400px;
        overflow-y: auto;
        padding-right: 10px;
      }

      /* Markdown styles */
      .ai-response-content h1,
      .ai-response-content h2,
      .ai-response-content h3 {
        color: var(--accent-color);
        margin: 1em 0 0.5em 0;
      }

      .ai-response-content p {
        margin: 0.5em 0;
        white-space: pre-wrap;
      }

      .ai-response-content ul,
      .ai-response-content ol {
        margin: 0.5em 0;
        padding-left: 1.5em;
      }

      .ai-response-content li {
        margin: 0.3em 0;
        white-space: pre-wrap;
      }

      .ai-response-content code {
        background: rgba(0, 0, 0, 0.2);
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: "Fira Code", monospace;
        font-size: 0.9em;
      }

      .ai-response-content pre {
        background: rgba(0, 0, 0, 0.2);
        padding: 1em;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1em 0;
        white-space: pre-wrap;
      }

      .ai-response-content pre code {
        background: none;
        padding: 0;
        white-space: pre-wrap;
        font-family: "Fira Code", monospace;
        font-size: 0.9em;
        color: #fff;
      }

      .ai-response-content blockquote {
        border-left: 3px solid var(--accent-color);
        margin: 1em 0;
        padding-left: 1em;
        color: #ccc;
        white-space: pre-wrap;
      }

      .ai-response.loading .ai-response-content {
        display: flex;
        align-items: center;
        gap: 15px;
        justify-content: center;
        min-height: 100px;
      }

      .ai-response.loading .loader {
        width: 30px;
        height: 30px;
        border-width: 3px;
      }

      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        z-index: 999;
      }

      .modal-overlay.show {
        display: block;
      }

      .nav-item a {
        color: var(--text-main) !important;
      }

      .nav-item a:hover {
        color: var(--accent-color) !important;
        text-decoration: none !important;
      }
    </style>
  </head>
  <body>
    <!-- Sidebar -->
    <nav class="sidebar d-flex flex-column align-items-center">
      <div class="nav-item levels">
        <a href="/"
          ><img
            src="/static/images/book-icon.png"
            alt="webscape-logo"
            width="50px"
        /></a>
        <br />
      </div>

      <div class="nav-item badges">
        <a href="/rankings">
          <i class="fas fa-award" aria-hidden="true"></i>
          <span>Rankings</span>
        </a>
      </div>
      <div class="nav-item options">
        <a href="/options">
          <i class="fas fa-paint-brush" aria-hidden="true"></i>
          <span>Options</span>
        </a>
      </div>
      <div class="nav-item account mt-auto mb-4">
        <i class="fas fa-user-circle" aria-hidden="true"></i>
        <span>Account</span>
      </div>
    </nav>

    <!-- Playground -->
    <div class="playground">
      <div class="section-title">
        <a href="/#game-modes"
          ><i class="fas fa-angle-left" style="margin-right: 1rem"></i> Code
          Playground</a
        >
      </div>

      <div class="tabs-container">
        <div class="tabs">
          <div class="tab active" data-lang="html">HTML</div>
          <div class="tab" data-lang="css">CSS</div>
          <div class="tab" data-lang="js">JavaScript</div>
          <button class="ai-fix-btn" id="aiFixBtn">
            <i class="fas fa-magic"></i>
            Analyze Your Code with AI
          </button>
        </div>
        <div class="live-output-label">
          <span>Live Output</span>
        </div>
      </div>

      <div class="editor-container">
        <div class="editor-loading">
          <span class="loader"></span>
        </div>
        <div class="editor">
          <!-- HTML Editor -->
          <div class="code-editor active" id="html-editor">
            <label for="html-code" class="visually-hidden"
              >HTML Code Editor</label
            >
            <textarea id="html-code" spellcheck="false">
&lt;h1 id="heading"&gt;Hello, Welcome to WebScape!&lt;/h1&gt;
&lt;button onclick="changeColor()"&gt;Click Me!&lt;/button&gt;</textarea
            >
          </div>

          <!-- CSS Editor -->
          <div class="code-editor" id="css-editor">
            <label for="css-code" class="visually-hidden"
              >CSS Code Editor</label
            >
            <textarea
              id="css-code"
              spellcheck="false"
              title="CSS Code Editor"
              placeholder="Write your CSS code here"
            >
h1 { color: blue; }</textarea
            >
          </div>

          <!-- JS Editor -->
          <div class="code-editor" id="js-editor">
            <label for="js-code" class="visually-hidden"
              >JavaScript Code Editor</label
            >
            <textarea id="js-code" spellcheck="false">
function changeColor() {
    document.getElementById("heading").style.color = "red";
}</textarea
            >
          </div>
        </div>

        <!-- Live output -->
        <div class="live-output">
          <iframe
            id="output-frame"
            sandbox="allow-scripts allow-same-origin"
            title="Playground live preview"
          ></iframe>
          <div class="debug-panel" id="debug-panel">
            <div class="debug-panel-header">
              <span>Debug Console</span>
              <div class="debug-panel-actions">
                <button
                  type="button"
                  class="debug-toggle-btn"
                  id="debug-toggle-btn"
                  aria-expanded="true"
                  aria-label="Collapse debug console"
                >
                  <i class="fas fa-chevron-up" aria-hidden="true"></i>
                </button>
                <button
                  type="button"
                  class="debug-clear-btn"
                  id="clear-debug-btn"
                >
                  <i class="fas fa-trash" aria-hidden="true"></i>
                  Clear
                </button>
              </div>
            </div>
            <div class="debug-panel-body" id="debug-log">
              <div class="debug-placeholder" id="debug-placeholder">
                Console output from your JavaScript will appear here.
              </div>
            </div>
          </div>
        </div>

        <div class="modal-overlay" id="modalOverlay"></div>
        <div class="ai-response" id="aiResponse">
          <div class="ai-response-header">
            <div class="ai-response-title">
              <i class="fas fa-robot"></i>
              AI Analysis
              <span
                class="beta-badge fs-7 fw-bold bg-danger text-white px-1 border-radius-5"
                style="font-size: 0.7rem"
                >BETA</span
              >
            </div>
            <button
              class="ai-response-close"
              id="aiResponseClose"
              aria-label="Close"
            >
              <span class="visually-hidden">Close</span>
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="ai-response-content">
            <div class="loader"></div>
            Analyzing your code...
          </div>
        </div>
      </div>
    </div>

    <!-- FontAwesome -->
    <script
      src="https://kit.fontawesome.com/yourkitid.js"
      crossorigin="anonymous"
    ></script>

    <!-- CodeMirror JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <!-- Add marked library for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchtags.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/css-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/anyword-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/markdown-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/comment-fold.min.js"></script>

    <script src="/static/playground.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const outputFrame = document.getElementById("output-frame");
        if (!outputFrame) {
          return;
        }

        const baseTag = document.createElement("base");
        baseTag.href = "about:blank";
        if (outputFrame.contentDocument && outputFrame.contentDocument.head) {
          outputFrame.contentDocument.head.appendChild(baseTag);
        }

        const debugPanel = document.getElementById("debug-panel");
        const debugLog = document.getElementById("debug-log");
        const debugPlaceholder = document.getElementById("debug-placeholder");
        const clearDebugBtn = document.getElementById("clear-debug-btn");
        const debugToggleBtn = document.getElementById("debug-toggle-btn");

        let activeOutputWindow = outputFrame.contentWindow || null;
        let debugPanelCollapsed = false;

        function setDebugPanelCollapsed(collapsed) {
          debugPanelCollapsed = !!collapsed;
          if (debugPanel) {
            debugPanel.classList.toggle("collapsed", debugPanelCollapsed);
          }
          if (debugToggleBtn) {
            debugToggleBtn.setAttribute(
              "aria-expanded",
              (!debugPanelCollapsed).toString()
            );
            debugToggleBtn.setAttribute(
              "aria-label",
              debugPanelCollapsed
                ? "Expand debug console"
                : "Collapse debug console"
            );
            debugToggleBtn.innerHTML = debugPanelCollapsed
              ? '<i class="fas fa-chevron-down" aria-hidden="true"></i>'
              : '<i class="fas fa-chevron-up" aria-hidden="true"></i>';
          }
        }

        function formatConsoleArgs(args) {
          if (!Array.isArray(args) || args.length === 0) {
            return "";
          }

          return args
            .map((arg) => {
              if (typeof arg === "string") {
                return arg;
              }
              if (arg === null) {
                return "null";
              }
              if (arg === undefined) {
                return "undefined";
              }
              if (
                typeof arg === "number" ||
                typeof arg === "boolean" ||
                typeof arg === "bigint"
              ) {
                return String(arg);
              }
              if (arg instanceof Error) {
                return arg.message || arg.toString();
              }
              if (typeof arg === "function") {
                return arg.toString();
              }
              try {
                return JSON.stringify(arg, null, 2);
              } catch (err) {
                return Object.prototype.toString.call(arg);
              }
            })
            .join(" ");
        }

        function clearDebugConsole(showPlaceholder = true) {
          if (!debugLog) {
            return;
          }
          debugLog.querySelectorAll(".debug-entry").forEach((entry) => {
            entry.remove();
          });
          if (debugPlaceholder) {
            debugPlaceholder.style.display = showPlaceholder ? "block" : "none";
          }
        }

        function appendDebugEntry(payload) {
          if (!debugLog || !payload) {
            return;
          }

          if (debugPlaceholder) {
            debugPlaceholder.style.display = "none";
          }

          const levelKey =
            payload.level === "table" ? "log" : payload.level || "log";
          const entry = document.createElement("div");
          entry.className = `debug-entry debug-${levelKey}`;

          const timeSpan = document.createElement("span");
          timeSpan.className = "debug-entry-time";
          timeSpan.textContent = new Date().toLocaleTimeString();
          entry.appendChild(timeSpan);

          const textSpan = document.createElement("span");
          textSpan.className = "debug-entry-text";

          if (payload.type === "console") {
            const prefix = payload.level === "table" ? "[table] " : "";
            textSpan.textContent =
              prefix + formatConsoleArgs(payload.args || []);
          } else {
            const segments = [];
            if (payload.message) {
              segments.push(payload.message);
            }
            if (payload.source) {
              const origin = window.location.origin;
              const cleanedSource = payload.source.startsWith(origin)
                ? payload.source.slice(origin.length)
                : payload.source;
              const locationParts = [cleanedSource];
              if (payload.lineno) {
                locationParts.push(payload.lineno);
              }
              if (payload.colno) {
                locationParts.push(payload.colno);
              }
              segments.push(`(${locationParts.join(":")})`);
            }
            textSpan.textContent = segments.join(" ");
          }

          entry.appendChild(textSpan);

          if (payload.stack) {
            const stackEl = document.createElement("pre");
            stackEl.className = "debug-entry-stack";
            stackEl.textContent = payload.stack;
            entry.appendChild(stackEl);
          }

          debugLog.appendChild(entry);
          debugLog.scrollTop = debugLog.scrollHeight;
        }

        function installFrameDebugging(frameWindow) {
          if (!frameWindow || frameWindow.__webscapeDebugInstalled) {
            return;
          }

          const levels = ["log", "info", "warn", "error", "debug", "table"];
          const consoleHost = frameWindow.console || (frameWindow.console = {});

          levels.forEach((level) => {
            const original =
              typeof consoleHost[level] === "function"
                ? consoleHost[level].bind(consoleHost)
                : null;
            consoleHost[level] = function (...args) {
              appendDebugEntry({ type: "console", level, args });
              if (original) {
                try {
                  original(...args);
                } catch (err) {
                  // Suppress console forwarding errors inside sandboxed iframe
                }
              }
            };
          });

          const originalClear =
            typeof consoleHost.clear === "function"
              ? consoleHost.clear.bind(consoleHost)
              : null;
          consoleHost.clear = function () {
            clearDebugConsole(true);
            if (originalClear) {
              try {
                originalClear();
              } catch (err) {
                // Ignore sandbox errors during clear
              }
            }
          };

          frameWindow.addEventListener(
            "error",
            function (event) {
              appendDebugEntry({
                type: "error",
                level: "error",
                message: event.message || "Uncaught error",
                source: event.filename || "",
                lineno: event.lineno,
                colno: event.colno,
                stack:
                  event.error && event.error.stack
                    ? String(event.error.stack)
                    : "",
              });
            },
            false
          );

          frameWindow.addEventListener(
            "unhandledrejection",
            function (event) {
              const reason = event.reason;
              appendDebugEntry({
                type: "error",
                level: "error",
                message:
                  (reason && reason.message) ||
                  (typeof reason === "string"
                    ? reason
                    : "Unhandled promise rejection"),
                stack: reason && reason.stack ? String(reason.stack) : "",
              });
            },
            false
          );

          frameWindow.__webscapeDebugInstalled = true;
          activeOutputWindow = frameWindow;
        }

        if (clearDebugBtn) {
          clearDebugBtn.addEventListener("click", function () {
            if (
              activeOutputWindow &&
              activeOutputWindow.console &&
              typeof activeOutputWindow.console.clear === "function"
            ) {
              try {
                activeOutputWindow.console.clear();
                return;
              } catch (err) {
                // ignore sandbox exceptions during manual clear
              }
            }
            clearDebugConsole(true);
          });
        }

        if (debugToggleBtn) {
          debugToggleBtn.addEventListener("click", function () {
            setDebugPanelCollapsed(!debugPanelCollapsed);
          });
        }

        setDebugPanelCollapsed(false);

        installFrameDebugging(activeOutputWindow);
        clearDebugConsole(true);

        // Initialize CodeMirror editors
        const htmlEditor = CodeMirror.fromTextArea(
          document.getElementById("html-code"),
          {
            mode: "htmlmixed",
            theme: "dracula",
            lineNumbers: true,
            autoCloseTags: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            matchTags: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            extraKeys: {
              Tab: function (cm) {
                if (cm.somethingSelected()) {
                  cm.indentSelection("add");
                } else {
                  cm.replaceSelection("  ", "end");
                }
              },
            },
            hintOptions: {
              completeSingle: false,
              hint: CodeMirror.hint.auto,
            },
          }
        );

        htmlEditor.on("inputRead", function (cm, change) {
          if (change.text[0] !== " ") {
            // Avoid triggering on space
            cm.showHint({ completeSingle: false });
          }
        });

        const cssEditor = CodeMirror.fromTextArea(
          document.getElementById("css-code"),
          {
            mode: "css",
            theme: "dracula",
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            extraKeys: {
              Tab: function (cm) {
                if (cm.somethingSelected()) {
                  cm.indentSelection("add");
                } else {
                  cm.replaceSelection("  ", "end");
                }
              },
            },
            hintOptions: {
              completeSingle: false,
              hint: CodeMirror.hint.auto,
            },
          }
        );

        cssEditor.on("inputRead", function (cm, change) {
          if (change.text[0] !== " ") {
            // Avoid triggering on space
            cm.showHint({ completeSingle: false });
          }
        });

        const jsEditor = CodeMirror.fromTextArea(
          document.getElementById("js-code"),
          {
            mode: "javascript",
            theme: "dracula",
            lineNumbers: true,
            autoCloseBrackets: true,
            matchBrackets: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            extraKeys: {
              Tab: function (cm) {
                if (cm.somethingSelected()) {
                  cm.indentSelection("add");
                } else {
                  cm.replaceSelection("  ", "end");
                }
              },
            },
            hintOptions: {
              completeSingle: false,
              hint: CodeMirror.hint.auto,
            },
          }
        );

        jsEditor.on("inputRead", function (cm, change) {
          if (change.text[0] !== " ") {
            // Avoid triggering on space
            cm.showHint({ completeSingle: false });
          }
        });

        // Function to sanitize HTML
        function sanitizeHTML(html) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");
          return doc.body.innerHTML;
        }

        // Function to validate and fix HTML
        function validateHTML(html) {
          const temp = document.createElement("div");
          temp.innerHTML = html;

          const unclosedTags = [];
          const stack = [];
          const regex = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
          let match;

          while ((match = regex.exec(html)) !== null) {
            const tag = match[1].toLowerCase();
            if (match[0].startsWith("</")) {
              if (stack.length > 0 && stack[stack.length - 1] === tag) {
                stack.pop();
              }
            } else if (!match[0].endsWith("/>")) {
              stack.push(tag);
            }
          }

          let fixedHTML = html;
          while (stack.length > 0) {
            const tag = stack.pop();
            fixedHTML += `</${tag}>`;
          }

          return fixedHTML;
        }

        // Update the live output with sanitized and validated HTML
        function updateOutput() {
          clearDebugConsole(true);

          const htmlCode = htmlEditor.getValue();
          const cssCode = cssEditor.getValue();
          const jsCode = jsEditor.getValue();

          const validatedHTML = validateHTML(htmlCode);
          const sanitizedHTML = sanitizeHTML(validatedHTML);

          const outputWindow = outputFrame.contentWindow || null;
          if (outputWindow) {
            installFrameDebugging(outputWindow);
          }

          try {
            const outputDoc = outputFrame.contentDocument;
            outputDoc.open();
            outputDoc.write(`
              <!DOCTYPE html>
              <html>
                <head>
                  <style>${cssCode}</style>
                </head>
                <body>
                  ${sanitizedHTML}
                  <script>${jsCode}<\/script>
                </body>
              </html>
            `);
            outputDoc.close();
          } catch (error) {
            appendDebugEntry({
              type: "error",
              level: "error",
              message: (error && error.message) || "Failed to render preview",
              stack: error && error.stack ? String(error.stack) : "",
            });
          }
        }

        // Add event listeners to all editors
        [htmlEditor, cssEditor, jsEditor].forEach((editor) => {
          editor.on("change", updateOutput);
        });

        // Tab switching
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            // Remove active class from all tabs and editors
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".code-editor")
              .forEach((e) => e.classList.remove("active"));

            // Add active class to clicked tab and corresponding editor
            this.classList.add("active");
            const lang = this.getAttribute("data-lang");
            document.getElementById(`${lang}-editor`).classList.add("active");

            // Refresh the active editor
            const editor =
              lang === "html"
                ? htmlEditor
                : lang === "css"
                ? cssEditor
                : jsEditor;
            editor.refresh();
          });
        });

        // AI Code Fix functionality
        const aiFixBtn = document.getElementById("aiFixBtn");
        const aiResponse = document.getElementById("aiResponse");
        const aiResponseClose = document.getElementById("aiResponseClose");
        let currentEditor = htmlEditor;

        // Update current editor when switching tabs
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", function () {
            const lang = this.getAttribute("data-lang");
            currentEditor =
              lang === "html"
                ? htmlEditor
                : lang === "css"
                ? cssEditor
                : jsEditor;
          });
        });

        // Function to properly encode Unicode strings to base64
        function encodeBase64Unicode(str) {
          // First encode the string to handle Unicode characters
          const encodedStr = encodeURIComponent(str);
          // Then convert to base64
          const base64 = btoa(encodedStr);
          // Add padding if needed
          const padding = 4 - (base64.length % 4);
          return padding === 4 ? base64 : base64 + "=".repeat(padding);
        }

        async function analyzeCode() {
          // Clear previous response and show loading state
          aiResponse.querySelector(".ai-response-content").innerHTML =
            '<div class="loader"></div>Analyzing your code...';
          aiResponse.classList.add("loading", "show");

          // Get code from all editors
          const htmlCode = htmlEditor.getValue();
          const cssCode = cssEditor.getValue();
          const jsCode = jsEditor.getValue();

          try {
            // Construct message with all three code sections
            const message = `[Your Role: Point out any errors in this code or confirm it's fine. Analyze all three sections (HTML, CSS, and JavaScript) together to check for any mismatches or issues.]\n\nHTML:\n${htmlCode}\n\nCSS:\n${cssCode}\n\nJavaScript:\n${jsCode}\n\n[IMPORTANT!]: Provide response in straightforward manner, focusing on actual code issues like:\n- "The function name in onclick should be changeColor() not changered()"\n- "Missing closing tag for h1 element"\n- "Incorrect attribute name: should be class not className"\n- "Missing semicolon at the end of the statement", if no errors are found, say "No issues found in the code."`;

            // Send POST request to Gemini-powered backend
            const response = await fetch("/api/analyze-code", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ message }),
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            aiResponse.classList.remove("loading");

            let responseText = "";
            if (data && typeof data.result === "string") {
              responseText = data.result.trim();
            } else if (data && typeof data.raw === "string") {
              responseText = data.raw.trim();
            } else {
              responseText = "No issues found in your code.";
            }

            // Convert newlines to <br> for HTML rendering
            responseText = responseText.replace(/\n/g, "<br>");

            // Configure marked options
            marked.setOptions({
              breaks: true, // Convert \n to <br>
              gfm: true, // GitHub Flavored Markdown
              headerIds: false,
              mangle: false,
              pedantic: false, // Don't be too strict about markdown
              smartLists: true, // Use smarter list behavior
              smartypants: true, // Use "smart" typographic punctuation
            });

            // Convert to markdown and render
            const formattedResponse = marked.parse(responseText);

            aiResponse.querySelector(".ai-response-content").innerHTML =
              formattedResponse;
          } catch (error) {
            console.error("Error:", error);
            aiResponse.classList.remove("loading");
            aiResponse.querySelector(".ai-response-content").innerHTML =
              "Sorry, there was an error analyzing your code.";
          }
        }

        // Update modal handling
        const modalOverlay = document.getElementById("modalOverlay");

        aiFixBtn.addEventListener("click", () => {
          modalOverlay.classList.add("show");
          aiResponse.classList.add("show");
          analyzeCode();
        });

        aiResponseClose.addEventListener("click", () => {
          modalOverlay.classList.remove("show");
          aiResponse.classList.remove("show");
        });

        modalOverlay.addEventListener("click", () => {
          modalOverlay.classList.remove("show");
          aiResponse.classList.remove("show");
        });

        // Initial update and remove loading state
        Promise.all([
          new Promise((resolve) => {
            // Check if editor is already initialized
            if (htmlEditor.getValue()) {
              resolve();
            } else {
              htmlEditor.on("change", resolve, { once: true });
            }
          }),
          new Promise((resolve) => {
            if (cssEditor.getValue()) {
              resolve();
            } else {
              cssEditor.on("change", resolve, { once: true });
            }
          }),
          new Promise((resolve) => {
            if (jsEditor.getValue()) {
              resolve();
            } else {
              jsEditor.on("change", resolve, { once: true });
            }
          }),
        ])
          .then(() => {
            updateOutput();
            document.querySelector(".editor-loading").style.display = "none";
          })
          .catch(() => {
            // Fallback in case of any issues
            setTimeout(() => {
              updateOutput();
              document.querySelector(".editor-loading").style.display = "none";
            }, 1000);
          });
      });
    </script>
  </body>
</html>
