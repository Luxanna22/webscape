<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>WebScape</title>
    <link
      rel="icon"
      href="/static/images/playground-mode.png"
      type="image/png"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
    />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Anton&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-darker.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/comment-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/xml-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/html-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchtags.min.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Luckiest+Guy&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap");

      :root {
        --bg-color: #240e44;
        --secondary-color: #371569;
        --accent-color: #ff66c4;
        --purple-accent: #7e31ef;
      }
      a[href="https://confettipage.com"]
      {
        display: none !important;
      }

      #quiz-form {
        margin-top: 2rem;
      }
      button#next-btn:disabled {
        background-color: gray;
        color: white;
      }

      * {
        box-sizing: border-box;
        /* list-style-type: none; */
        padding: 0;
        margin: 0;
      }

      /* Restore list styles for lesson content */
      .content ul,
      .content ol {
        list-style: initial !important;
        margin-left: 2em;
        padding-left: 1.5em;
      }
      .content li {
        display: list-item !important;
      }

      body,
      html {
        margin: 0;
        padding: 0;
        height: 100%;
        background-color: var(--bg-color);
        color: #a9a9a9;
        font-family: "Montserrat", sans-serif;
        overflow: hidden;
      }

      .sidebar {
        background-color: #3a1464;
        width: 90px;
        height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 20px;
        gap: 50px;
        z-index: 200;
      }
      .sidebar .nav-item {
        text-align: center;
        font-weight: 500;
        font-size: 14px;
        color: #a9a9a9;
        user-select: none;
      }
      .sidebar .nav-item i {
        font-size: 28px;
        display: block;
        margin-bottom: 6px;
        color: #a9a9a9;
      }
      .sidebar .nav-item.badges i {
        color: #bfbfbf;
      }
      .sidebar .nav-item.account i {
        font-size: 32px;
        color: #bfbfbf;
      }
      .sidebar .nav-item:hover {
        color: #ff69b4;
      }
      .sidebar .nav-item:hover i {
        color: #ff69b4;
      }

      .main-content {
        margin-left: 90px;
        padding: 20px;
        height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .section-header,
      .section-header a {
        color: white;
        font-family: "Luckiest Guy", cursive;
        font-size: 24px;
        margin-bottom: 10px;
        text-decoration: none;
      }
      .section-header:hover,
      .section-header a:hover {
        color: var(--accent-color);
      }
      /*  */
      .section-title,
      .section-title a {
        color: white;
        font-family: "Luckiest Guy", cursive;
        font-size: 24px;
        margin-bottom: 10px;
        text-decoration: none;
      }
      .section-title:hover,
      .section-title a:hover {
        color: var(--accent-color);
      }
      .section-content {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        margin: auto 20%;
        border-radius: 10px;
        scrollbar-width: none;
      }
      .section-footer {
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: 0;
        background-color: transparent;
        position: fixed;
        bottom: 0;
        left: 80px;
        width: calc(100% - 80px);
        transition: background-color 0.3s ease;
      }
      .section-footer.has-result {
        background-color: #4d1e91;
      }
      .section-footer.has-result .end-btn {
        background-color: var(--accent-color);
      }
      .section-footer.has-result .end-btn:hover {
        background-color: var(--purple-accent);
      }
      .dynamic-text-result {
        padding: 20px;
        overflow-y: auto;
      }
      .dynamic-text-result-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin: auto 20%;
      }
      .end-btn {
        background-color: var(--purple-accent);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 20px;
        font-family: "Luckiest Guy", cursive;
        transition: background-color 0.3s ease;
      }
      .end-btn:hover {
        background-color: var(--accent-color);
        color: white;
      }
      .end-btn:active {
        background-color: var(--accent-color);
        color: white;
      }
      .progress-bar {
        position: fixed;
        top: 0;
        left: 80px;
        width: 100%;
        height: 4px;
        background-color: var(--secondary-color);
      }
      .progress-bar .progress {
        height: 10px;
        background-color: var(--purple-accent);
        transition: width 0.05s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .form-check {
        margin-bottom: 1.3rem;
        padding: 0;
      }
      .form-check-input {
        display: none;
      }
      .form-check-label {
        display: block;
        padding: 16px 24px;
        background-color: var(--purple-accent);
        color: white;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .form-check-label:hover {
        background-color: var(--accent-color);
      }
      .form-check-input:checked + .form-check-label {
        background-color: var(--accent-color);
        box-shadow: 0 0 10px rgba(255, 102, 196, 0.5);
      }
      .form-check-input:checked.incorrect + .form-check-label {
        background-color: #dc3545;
        box-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
      }
      .form-check-label.correct {
        border: 2px solid #28a745;
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
      }
      /* Disable hover and interaction when quiz is answered */
      .quiz-answered .form-check-label {
        cursor: default;
        opacity: 0.7;
      }
      .quiz-answered .form-check-label:hover {
        background-color: var(--purple-accent);
      }
      .quiz-answered .form-check-input:checked + .form-check-label,
      .quiz-answered .form-check-label.correct {
        opacity: 1;
      }

      .loader-container {
        position: fixed;
        top: 0;
        left: 90px;
        width: calc(100% - 90px);
        height: 100%;
        background-color: var(--bg-color);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .congrats-summary {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        opacity: 0;
        animation: fadeIn 0.5s 0.2s ease-out forwards;
      }

      .congrats-summary .congrats-title,
      .congrats-summary .congrats-subtitle,
      .congrats-summary .rewards,
      .congrats-summary .cta {
        opacity: 0;
        transform: translateY(20px);
        animation: slideUpFadeIn 0.6s ease-out forwards;
      }

      .congrats-summary .congrats-title {
        animation-delay: 0.5s;
      }

      .congrats-summary .congrats-subtitle {
        animation-delay: 0.7s;
      }

      .congrats-summary .rewards {
        animation-delay: 0.9s;
      }

      .congrats-summary .cta {
        animation-delay: 1.1s;
      }

      .congrats-summary .rewards span {
        display: inline-block;
        transition: transform 0.2s ease;
      }
      .congrats-summary .rewards span:hover {
        transform: scale(1.1);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideUpFadeIn {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes checkBounce {
        0% {
          transform: scale(0) rotate(-45deg);
          opacity: 0;
        }
        50% {
          transform: scale(1.2) rotate(0deg);
          opacity: 1;
        }
        100% {
          transform: scale(1) rotate(0deg);
          opacity: 1;
        }
      }

      @keyframes wrongShake {
        0%,
        100% {
          transform: translateX(0);
        }
        10%,
        30%,
        50%,
        70%,
        90% {
          transform: translateX(-5px);
        }
        20%,
        40%,
        60%,
        80% {
          transform: translateX(5px);
        }
      }

      .playground-outer {
        background: #23223a;
        border-radius: 12px;
        box-shadow: 0 2px 12px 0 rgba(30, 20, 60, 0.1);
        padding: 0 0 12px 0;
        margin-bottom: 18px;
        margin-top: 10px;
        border: 1px solid #2d145c;
        max-width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
      .playground-toolbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #23223a;
        border-radius: 12px 12px 0 0;
        padding: 10px 18px 8px 18px;
        color: #fff;
        font-family: "Montserrat", sans-serif;
        font-size: 1.08rem;
        font-weight: 600;
        border-bottom: 1px solid #2d145c;
      }
      .playground-title {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.1rem;
        letter-spacing: 0.5px;
        color: #b3b3b3;
      }
      .playground-actions {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .playground-lang-select {
        background: #23223a;
        color: #b3b3b3;
        border: 1px solid #39386b;
        border-radius: 5px;
        padding: 3px 10px;
        font-size: 0.98rem;
        font-family: "Montserrat", sans-serif;
        outline: none;
        transition: border-color 0.2s;
        margin-right: 4px;
      }
      .playground-lang-select:focus {
        border-color: #7e31ef;
      }
      .playground-run-btn {
        background: #7e31ef;
        border: none;
        border-radius: 5px;
        color: #fff;
        font-weight: 600;
        font-size: 0.98rem;
        padding: 5px 16px;
        box-shadow: 0 1px 4px 0 rgba(126, 49, 239, 0.08);
        transition: background 0.18s;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .playground-run-btn:hover,
      .playground-run-btn:focus {
        background: #5a23b7;
      }
      #playground-editor-container .CodeMirror {
        font-size: 1.05rem;
        border-radius: 7px;
        background: #19182c;
        color: #fff;
        box-shadow: none;
        border: 1px solid #39386b;
        margin-bottom: 8px;
        min-height: 180px;
        max-height: 260px;
      }
      #playground-editor-container .CodeMirror-focused {
        border-color: #7e31ef;
        box-shadow: 0 0 0 1.5px #7e31ef;
      }
      .playground-output {
        background: #23223a;
        border: 1px solid #39386b;
        border-top: none;
        min-height: 40px;
        color: #e0e0e0;
        font-family: "Fira Mono", "Consolas", "Menlo", monospace;
        font-size: 1rem;
        margin-bottom: 10px;
        /* max-width: 600px; */
        margin-left: auto;
        margin-right: auto;
        box-shadow: none;
        padding: 12px 16px;
        transition: border-color 0.2s;
      }
      @media (max-width: 700px) {
        .playground-outer,
        .playground-output {
          max-width: 98vw;
          padding-left: 2vw;
          padding-right: 2vw;
        }
        #playground-editor-container .CodeMirror {
          font-size: 0.98rem;
        }
      }
      .playground-loader {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 60px;
      }
      .playground-fullscreen-btn {
        position: absolute;
        bottom: 30px;
        right: 15px;
        z-index: 10;
        background: #19182c;
        color: #fff;
        border: 1px solid #39386b;
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        box-shadow: 0 2px 8px 0 rgba(30, 20, 60, 0.08);
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }
      .playground-fullscreen-btn:hover {
        background: #7e31ef;
        color: #fff;
      }
      .playground-outer.fullscreen {
        position: fixed !important;
        top: 0;
        left: 0;
        width: 100vw !important;
        height: 100vh !important;
        max-width: 100vw !important;
        max-height: 100vh !important;
        z-index: 9999;
        background: #19182c;
        border-radius: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        padding: 0 !important;
      }
      .playground-outer.fullscreen #playground-editor-container,
      .playground-outer.fullscreen .CodeMirror {
        height: 100vh !important;
        min-height: 100vh !important;
        max-height: 100vh !important;
      }
      .playground-outer.fullscreen #playground-editor-container {
        flex: 1 1 0;
        min-width: 0;
        margin-bottom: 0;
      }
      .playground-outer.fullscreen ~ #playground-output {
        display: block !important;
        flex: 1 1 0;
        min-width: 0;
        height: 100vh !important;
        max-height: 100vh !important;
        margin: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        font-size: 1.1rem;
        overflow: auto;
      }
      @media (max-width: 900px) {
        .playground-outer.fullscreen {
          flex-direction: column;
        }
        .playground-outer.fullscreen #playground-editor-container,
        .playground-outer.fullscreen ~ #playground-output {
          height: 50vh !important;
          max-height: 50vh !important;
        }
      }
      .playground-header,
      .playground-output-header {
        background: #2d145c;
        color: #fff;
        font-weight: 600;
        padding: 10px 18px;
        border-bottom: 1px solid #39386b;
        font-size: 1.08rem;
        letter-spacing: 0.5px;
      }
      .playground-output-placeholder {
        color: #aaa;
        display: block;
        text-align: center;
        margin-top: 40px;
        font-size: 1.1rem;
      }
      .playground-fullscreen-wrapper.fullscreen {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        z-index: 9999;
        background: #19182c;
        display: flex;
        flex-direction: row;
        align-items: stretch;
        border-radius: 0 !important;
        margin: 0 !important;
        box-shadow: none !important;
        padding: 0 !important;
      }
      .playground-fullscreen-wrapper.fullscreen .playground-outer {
        flex: 1 1 0;
        min-width: 0;
        border-right: 2px solid #2d145c;
        background: #19182c;
        display: flex;
        flex-direction: column;
        height: 100% !important;
        max-height: 100% !important;
      }
      .playground-fullscreen-wrapper.fullscreen #playground-editor-container,
      .playground-fullscreen-wrapper.fullscreen .CodeMirror {
        flex: 1 1 0;
        height: 100% !important;
        min-height: 0 !important;
        max-height: 100% !important;
      }
      .playground-fullscreen-wrapper.fullscreen .playground-toolbar {
        border-radius: 0;
      }
      .playground-fullscreen-wrapper.fullscreen .playground-output {
        display: flex !important;
        flex-direction: column;
        flex: 1 1 0;
        min-width: 0;
        height: 100% !important;
        max-height: 100% !important;
        margin: 0 !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        font-size: 1.1rem;
        overflow: auto;
        border-left: 2px solid #2d145c;
        background: #23223a;
      }
      .playground-fullscreen-wrapper.fullscreen .playground-output-header {
        display: block !important;
      }
      .playground-fullscreen-wrapper.fullscreen #playground-output-content {
        flex: 1 1 0;
        height: 100%;
        overflow: auto;
        display: flex;
        flex-direction: column;
      }
      .playground-fullscreen-btn {
        position: absolute;
        bottom: 30px;
        right: 15px;
        z-index: 10;
        background: #19182c;
        color: #fff;
        border: 1px solid #39386b;
        border-radius: 50%;
        width: 38px;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        box-shadow: 0 2px 8px 0 rgba(30, 20, 60, 0.08);
        cursor: pointer;
        transition: background 0.2s, color 0.2s;
      }
      .playground-fullscreen-btn:hover {
        background: #7e31ef;
        color: #fff;
      }
      @media (max-width: 900px) {
        .playground-fullscreen-wrapper.fullscreen {
          flex-direction: column;
        }
        .playground-fullscreen-wrapper.fullscreen .playground-outer,
        .playground-fullscreen-wrapper.fullscreen .playground-output {
          height: 50% !important;
          max-height: 50% !important;
        }
        .playground-fullscreen-wrapper.fullscreen .playground-outer {
          border-right: none;
          border-bottom: 2px solid #2d145c;
        }
        .playground-fullscreen-wrapper.fullscreen .playground-output {
          border-left: none;
          border-top: 2px solid #2d145c;
        }
      }
    </style>
  </head>
  <body>
    <!-- Loader -->
    <div class="loader-container" id="loader-container">
      <dotlottie-player
        src="https://lottie.host/10fb778d-241e-4604-8a37-bbf4e061e93a/eBFMwd9fRi.lottie"
        background="transparent"
        speed="1"
        style="width: 250px; height: 250px; margin-bottom: 2rem"
        loop
        autoplay
      ></dotlottie-player>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar d-flex flex-column align-items-center">
      <div class="nav-item levels">
        <a href="/"
          ><img
            src="/static/images/book-icon.png"
            alt="webscape-logo"
            width="50px"
        /></a>
        <br />
      </div>
      <div class="nav-item levels">
        <i class="fas fa-bars" aria-hidden="true"></i>
        <span>Levels</span>
      </div>
      <div class="nav-item badges">
        <i class="fas fa-award" aria-hidden="true"></i>
        <span>Badges</span>
      </div>
      <div class="nav-item options">
        <i class="fas fa-paint-brush" aria-hidden="true"></i>
        <span>Options</span>
      </div>
      <div class="nav-item account mt-auto mb-4">
        <i class="fas fa-user-circle" aria-hidden="true"></i>
        <span>Account</span>
      </div>
    </nav>
    <!-- top-most line progress bar -->
    <div class="progress-bar">
      <div
        class="progress"
        style="width: {{ ((current_page - 1) / total_pages) * 100 }}%"
      ></div>
    </div>

    <div class="main-content">
      <div
        class="section-header d-flex justify-content-between align-items-center"
        style="margin-bottom: 20px"
      >
        <!-- Previous button -->
        <div style="flex: 1; text-align: left">
          <button
            id="prev-btn"
            class="btn btn-link text-white"
            style="font-size: 1.5rem; text-decoration: none; display: none"
            onclick="goPreviousPage()"
          >
            <i class="fas fa-angle-left"></i> Previous
          </button>
        </div>
        <!-- Chapter title -->
        <div
          style="
            flex: 2;
            text-align: center;
            font-family: 'Luckiest Guy', cursive;
            font-size: 2rem;
            color: white;
          "
        >
          {{ chapter.title }}
        </div>
        <!-- Exit button -->
        <div style="flex: 1; text-align: right">
          <button
            class="btn btn-link text-white"
            style="font-size: 1.5rem; text-decoration: none"
            onclick="exitLesson()"
          >
            <i class="fas fa-times"></i>
          </button>
        </div>
      </div>
      <div class="section-content" id="lesson-content-section">
        {% set page = lesson_pages[current_page-1] %} {% if page.page_type ==
        'text_image' %} {% if page.image_url %}
        <img
          src="{{ page.image_url }}"
          alt="{{ page.title }}"
          style="
            width: auto;
            height: 200px;
            text-align: center;
            display: block;
            margin: 0 auto 20px auto;
          "
        />
        {% endif %}
        <div class="content-section">
          <h2>{{ page.title }}</h2>
          <div class="content">{{ page.content|safe }}</div>
          {% if page.notes %}
          <div
            class="notes-section mt-3 p-3"
            style="
              background-color: #240e44;
              border: 1px solid #a259ff;
              border-radius: 8px;
            "
          >
            <h5 style="color: #a259ff; margin-bottom: 10px">Notes</h5>
            <div class="content">{{ page.notes }}</div>
          </div>
          {% endif %}
        </div>
        {% elif page.page_type == 'text_code' %}
        <div class="content">{{ page.content|safe }}</div>
        {% if page.code_example %}
        <pre><code class="language-html">{{ page.code_example }}</code></pre>
        {% endif %} {% elif page.page_type == 'quiz' %}
        <div class="content">{{ page.content|safe }}</div>
        <form id="quiz-form">
          {% if page.choices %} {% for choice in page.choices %}
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="quiz_choice"
              id="choice{{ loop.index }}"
              value="{{ choice.id }}"
            />
            <label class="form-check-label" for="choice{{ loop.index }}">
              {{ choice.choice_text }}
            </label>
          </div>
          {% endfor %} {% else %}
          <div class="content"><em>No choices available.</em></div>
          {% endif %}
        </form>
        {% elif page.page_type == 'playground' %}
        <div class="content">{{ page.content|safe }}</div>
        <div
          id="playground-fullscreen-wrapper"
          class="playground-fullscreen-wrapper"
        >
          <div
            id="playground-editor-outer"
            class="playground-outer position-relative"
          >
            <div class="playground-toolbar">
              <span class="playground-title"
                ><i class="fas fa-code"></i> Code Playground</span
              >
              <div class="playground-actions">
                <select
                  id="playground-language"
                  class="playground-lang-select"
                  onchange="changePlaygroundMode(this.value)"
                >
                  <option value="htmlmixed">HTML/CSS/JS</option>
                  <option value="xml">XML</option>
                  <option value="javascript">JavaScript</option>
                  <option value="css">CSS</option>
                </select>
                <button
                  class="btn btn-success playground-run-btn"
                  onclick="runPlaygroundCode()"
                >
                  <i class="fas fa-play"></i> Run
                </button>
              </div>
            </div>
            <div id="playground-editor-container">
              <textarea id="playground-editor">
{{ page.code_example|default('', true) }}</textarea
              >
            </div>
            <button
              id="playground-fullscreen-btn"
              class="playground-fullscreen-btn"
              title="Fullscreen"
              type="button"
            >
              <i class="fas fa-expand"></i>
            </button>
          </div>
          <div
            id="playground-output"
            class="playground-output"
            style="display: none"
          >
            <div class="playground-output-header" style="display: none">
              Output
            </div>
            <div id="playground-output-content">
              <span class="playground-output-placeholder">No output yet</span>
            </div>
          </div>
        </div>
        <!-- CodeMirror will be initialized in the main script at the end of <body> -->
        {% else %}
        <div class="content">{{ page.content|safe }}</div>
        {% endif %}
      </div>
    </div>
    <div class="section-footer">
      <div class="dynamic-text-result-container">
        <div class="dynamic-text-result" id="dynamic-text-result">
          <div id="quiz-feedback" class="mt-2"></div>
        </div>
      </div>
      <button class="btn end-btn" id="next-btn" onclick="footerNextAction()">
        {{ lesson_pages[current_page-1].next_button_text }}
      </button>
    </div>

    <!-- Add a hidden input to store current progress -->
    <input
      type="hidden"
      id="user-current-progress"
      value="{{ progress['progress'] if progress else 0 }}"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-html.min.js"></script>
    <script
      src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
      type="module"
    ></script>
    <script>
      let currentPage = {{ current_page }};
      const totalPages = {{ total_pages }};
      const chapterId = {{ chapter.id }};
      const level = "{{ chapter.level_title }}";
      let quizChoices = null;  // Initialize as null, will be set after AJAX load
      let confettiShown = false;

      // Hide loader when content is loaded with minimum 2 seconds
      window.addEventListener('load', function() {
        const loader = document.getElementById('loader-container');
        const startTime = Date.now();
        const minimumLoadTime = 2000; // 2 seconds in milliseconds

        function hideLoader() {
          const elapsedTime = Date.now() - startTime;
          const remainingTime = Math.max(0, minimumLoadTime - elapsedTime);

          setTimeout(() => {
            if (loader) {
              loader.style.display = 'none';
            }
          }, remainingTime);
        }

        hideLoader();
      });

      // Animate progress bar from previous to new value
      function animateProgressBar(from, to) {
        const progressBar = document.querySelector('.progress');
        let start = null;
        const duration = 200;
        function step(timestamp) {
          if (!start) start = timestamp;
          const progress = Math.min((timestamp - start) / duration, 1);
          const value = from + (to - from) * progress;
          progressBar.style.width = `${value}%`;
          if (progress < 1) {
            requestAnimationFrame(step);
          }
        }
        requestAnimationFrame(step);
      }

      // Initial progress bar animation
      document.addEventListener('DOMContentLoaded', function() {
        const progress = ((currentPage - 1) / totalPages) * 100;
        animateProgressBar(0, progress);
      });

      // Show/hide Previous button based on currentPage
      function updatePrevButton() {
        const prevBtn = document.getElementById('prev-btn');
        if (currentPage > 1) {
          prevBtn.style.display = '';
        } else {
          prevBtn.style.display = 'none';
        }
      }
      document.addEventListener('DOMContentLoaded', updatePrevButton);

      // Quiz state for footer button
      let quizAnswered = false;
      let quizCorrect = false;
      let quizOriginalNextText = null;
      let quizPage = false;

      function updateQuizFooterButton() {
        const nextBtn = document.getElementById('next-btn');
        if (quizPage) {
          if (!quizAnswered) {
            nextBtn.textContent = 'Check';
            nextBtn.disabled = !document.querySelector('input[name="quiz_choice"]:checked');
          } else {
            nextBtn.textContent = quizOriginalNextText || 'Next';
            nextBtn.disabled = false;
          }
        } else {
          nextBtn.textContent = quizOriginalNextText || nextBtn.textContent;
          nextBtn.disabled = false;
        }
      }

      function footerNextAction() {
        if (quizPage && !quizAnswered) {
          checkQuizAnswer();
        } else {
          nextPage();
        }
      }

      // Quiz answer checking (client-side only, for demo)
      function checkQuizAnswer() {
        const form = document.getElementById('quiz-form');
        const selected = form.querySelector('input[name="quiz_choice"]:checked');
        const feedback = document.getElementById('quiz-feedback');
        const footer = document.querySelector('.section-footer');

        if (!selected) {
          feedback.textContent = 'Please select an answer.';
          feedback.style.color = 'orange';
          return;
        }

        // Reset previous highlights
        form.querySelectorAll('.form-check-input').forEach(input => {
          input.classList.remove('incorrect');
          input.nextElementSibling.classList.remove('correct');
        });

        // Get the selected choice ID and compare with correct answer
        const selectedId = selected.value;
        console.log('Selected ID:', selectedId);
        console.log('Quiz Choices:', quizChoices);

        // Find the correct choice
        const correctChoice = quizChoices.find(c => c.is_correct);
        console.log('Correct Choice:', correctChoice);

        // Compare the selected ID with the correct choice ID
        const isCorrect = correctChoice && selectedId === correctChoice.id.toString();
        console.log('Is Correct:', isCorrect);

        if (isCorrect) {
          // Random feedback messages for correct answers
          const correctMessages = [
            "Perfect!", "Excellent!", "Brilliant!", "Spot on!", "Amazing!",
            "Fantastic!", "Outstanding!", "Superb!", "Wonderful!", "Great job!",
            "You got it!", "That's right!", "Exactly!", "Well done!", "Impressive!"
          ];
          const randomMessage = correctMessages[Math.floor(Math.random() * correctMessages.length)];
          // Get the correct message from the hidden input
          const correctMessageInput = document.getElementById('correct-message');
          const customMessage = correctMessageInput ? correctMessageInput.value : '';

          feedback.innerHTML = `
            <div style="display: flex; align-items: flex-end; gap: 10px; color: limegreen; font-size: 1.5rem; ">
              <svg class="check-icon" width="44" height="44" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: checkBounce 0.6s ease-out;">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" fill="limegreen"/>
              </svg>
              <span>${randomMessage}</span>
            </div>
            ${customMessage ? `<div class="mt-2" style="color: #d3d3d3">${customMessage}</div>` : ''}
          `;
          quizCorrect = true;
        } else {
          // Random feedback messages for incorrect answers
          const incorrectMessages = [
            "Not quite.", "You'll get it next time.", "Ouch, not really.", "Not exactly.", "Close!",
            "Nahh!", "Keep trying.", "Not quite right.", "Incorrect.", "Not this time.",
            "Oops, that's wrong.", "Not quite there.", "Try once more.", "Not the one.", "Nice try."
          ];
          const randomMessage = incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];
          feedback.innerHTML = `
            <div style="display: flex; align-items: flex-end; gap: 10px; color: red; font-size: 1.5rem">
              <svg class="wrong-icon" width="44" height="44" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="animation: wrongShake 0.6s ease-out;">
                <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z" fill="red"/>
              </svg>
              <span>${randomMessage}</span>
            </div>
          `;
            quizCorrect = false;

          // Highlight incorrect choice
          selected.classList.add('incorrect');

          // Highlight correct answer
          if (correctChoice) {
            const correctInput = form.querySelector(`input[value="${correctChoice.id}"]`);
            if (correctInput) {
              correctInput.nextElementSibling.classList.add('correct');
            }
          }
        }

        // Disable all choices
        form.classList.add('quiz-answered');
        form.querySelectorAll('input[name="quiz_choice"]').forEach(input => {
          input.disabled = true;
        });

        quizAnswered = true;
        footer.classList.add('has-result');
        updateQuizFooterButton();
      }

      // Listen for quiz choice selection to enable the button
      function setupQuizChoiceListeners() {
        const quizChoicesInputs = document.querySelectorAll('input[name="quiz_choice"]');
        quizChoicesInputs.forEach(input => {
          input.addEventListener('change', function() {
            updateQuizFooterButton();
          });
        });
      }

      // On initial load, if progress is 100, always start at page 1
      document.addEventListener('DOMContentLoaded', function() {
        const userCurrentProgressInput = document.getElementById('user-current-progress');
        let userCurrentProgress = userCurrentProgressInput ? parseFloat(userCurrentProgressInput.value) : 0;
        if (userCurrentProgress >= 100) {
          currentPage = 1;
        }
        loadLessonPage(currentPage);
        const nextBtn = document.getElementById('next-btn');
        quizAnswered = false;
        quizCorrect = false;
        quizPage = false;
        quizOriginalNextText = nextBtn.textContent;
      });

      // AJAX navigation for next/previous page
      function loadLessonPage(pageNum) {
        fetch(`/user/classic/${level}/${chapterId}/ajax?page=${pageNum}`)
          .then(response => response.json())
          .then(data => {
            document.getElementById('lesson-content-section').innerHTML = data.html;
            const prevProgress = ((currentPage - 1) / totalPages) * 100;
            const newProgress = ((pageNum - 1) / totalPages) * 100;
            animateProgressBar(prevProgress, newProgress);
            currentPage = pageNum;
            if (window.Prism) { Prism.highlightAll(); }
            updatePrevButton();
            // Quiz/next button logic
            quizAnswered = false;
            quizCorrect = false;
            quizPage = false;
            quizOriginalNextText = data.next_button_text || 'Next';
            const nextBtn = document.getElementById('next-btn');
            // Clear dynamic text result (quiz feedback)
            document.getElementById('dynamic-text-result').innerHTML = '<div id="quiz-feedback" class="mt-2"></div>';
            if (data.is_congrats) {
              // Hide navigation/footer buttons
              if (nextBtn) nextBtn.style.display = 'none';
              const prevBtn = document.getElementById('prev-btn');
              if (prevBtn) prevBtn.style.display = 'none';
              document.querySelector('.section-footer').style.display = 'none';

              const triggerConfetti = () => {
                if (!confettiShown) {
                  const script = document.createElement('script');
                  script.src = 'https://run.confettipage.com/here.js';
                  script.setAttribute('data-confetticode', 'U2FsdGVkX1+nYz+H/kWOfHv3kjzg/+2AGyRBF7rTQDU0DZSB6Z1MMvOQ9Qz7PF1USOdIc0K2c2xa5XnayuJOiVvFkIPb8+tsxrqZiQj+lDhb67hlbGzZ64HoVrGt/Mf5SP5azO3Z2paXLPHHiMvAeG/Lr0xK7GQAmXnEndVnOWN23mqA/PFd7L+lkcBkLsQdbfuYANLjyLgNogu/8lyi7g4BrDiLLShJE0387OYmBq3CaG9JGvipunaU3JOwkdrt4a1cRdIGv35NR8ydMHeqNH+gqotRdeey5nG8XABIo40lvoYtD2YHY5C5g5UUoLYS0ShVJ8clsYrOlAg6xi/vbBQ6mBaqPYq2kwpdF7uBuLsShGiZB4ra2JzwnZterA4XBUvje+tth1u9ihMusYMGWDQ9LFrngpq5MRo5CchpgGAL0BFNt21QhnnCsNikcpVCqCW6py6YBm0XL5YMhbb94h4beflumTmrW6mD8kFYW4Ur6TvZsBHgzZShcpTNxEWnhjA3cEPg5YkxnFAJb45UcIfSFxYVzXwZ39iHO4MDTGbIvCWxJkCsdoncGB9YLwSczLTRL+/ItXeZ7eVhOtf9rILGISgCBoZRhQ1FJHhSlXZ9Um6WfIqAlt3c+XIJXLj1hBdMJNtuLWCf2rNHQ4m0mJOn3jhYcNu6GfDIqx7xTlZStyeNIevXpEi//+NzAyzA4IpJVUtbJnPSFr5K6fboAw==');
                  document.body.appendChild(script);
                  confettiShown = true;
                }
              };

              // Ensure progress is set to 100% and completed=1 before triggering confetti
              const userCurrentProgressInput = document.getElementById('user-current-progress');
              let userCurrentProgress = userCurrentProgressInput ? parseFloat(userCurrentProgressInput.value) : 0;
              if (userCurrentProgress < 100) {
                fetch(`/user/classic/${level}/${chapterId}/progress`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ page_num: totalPages, total_pages: totalPages })
                }).then(response => response.json()).then(data => {
                  if (data.success && userCurrentProgressInput) {
                    userCurrentProgressInput.value = 100;
                    triggerConfetti();
                  }
                });
              } else {
                triggerConfetti();
              }
              return;
            } else {
              document.querySelector('.section-footer').style.display = '';
            }
            if (document.getElementById('quiz-form')) {
              quizPage = true;
              nextBtn.textContent = 'Check';
              nextBtn.disabled = true;
              setupQuizChoiceListeners();
              initializeQuizChoices();
            } else {
              nextBtn.textContent = quizOriginalNextText;
              nextBtn.disabled = false;
            }
            // Reset confetti flag if not on congrats page
            confettiShown = false;
            // After content is inserted, initialize CodeMirror if needed
            initializePlaygroundEditor();
          });
      }

      function nextPage() {
        const userCurrentProgressInput = document.getElementById('user-current-progress');
        let userCurrentProgress = userCurrentProgressInput ? parseFloat(userCurrentProgressInput.value) : 0;
        const newProgress = ((currentPage) / totalPages) * 100;
        if (currentPage < totalPages) {
          // Only update progress if newProgress is greater than stored progress
          if (newProgress > userCurrentProgress) {
            fetch(`/user/classic/${level}/${chapterId}/progress`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                page_num: currentPage,
                total_pages: totalPages
              })
            }).then(response => response.json()).then(data => {
              // Update stored progress if update was successful and progress increased
              if (data.success && data.progress > userCurrentProgress) {
                if (userCurrentProgressInput) userCurrentProgressInput.value = data.progress;
              }
              // Move to next page via AJAX
              document.getElementById('dynamic-text-result').innerHTML = '<div id="quiz-feedback" class="mt-2"></div>';
              loadLessonPage(currentPage + 1);
              // remove class has-result to section-footer
              document.querySelector('.section-footer').classList.remove('has-result');
            });
          } else {
            // Just move to next page without updating progress
            document.getElementById('dynamic-text-result').innerHTML = '<div id="quiz-feedback" class="mt-2"></div>';
            loadLessonPage(currentPage + 1);
            document.querySelector('.section-footer').classList.remove('has-result');
          }
        } else {
          // Chapter completed: show congrats page via AJAX
          loadLessonPage(currentPage + 1);
        }
      }

      function goPreviousPage() {
        if (currentPage > 1) {
          document.getElementById('dynamic-text-result').innerHTML = '<div id="quiz-feedback" class="mt-2"></div>';
          loadLessonPage(currentPage - 1);
        }
        // remove class has-result to section-footer
        document.querySelector('.section-footer').classList.remove('has-result');
      }

      function exitLesson() {
        window.location.href = `/user/classic/${level}`;
      }

      // Playground code runner (HTML/JS only, for demo)
      function runPlaygroundCode() {
        var code = window.codeMirrorInstance ? window.codeMirrorInstance.getValue() : document.getElementById('playground-editor').value;
        var output = document.getElementById('playground-output');
        var outputContent = document.getElementById('playground-output-content');
        // Show loader
        output.style.display = '';
        outputContent.innerHTML = '<div class="playground-loader" style="display: flex; align-items: center; justify-content: center; height: 60px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        setTimeout(function() {
          try {
            outputContent.innerHTML = '';
            var iframe = document.createElement('iframe');
            iframe.style.width = '100%';
            iframe.style.height = '150px';
            iframe.style.background = '#fff';
            if (document.querySelector('.playground-fullscreen-wrapper.fullscreen')) {
              iframe.style.height = '100%';
            }
            outputContent.appendChild(iframe);
            var doc = iframe.contentDocument || iframe.contentWindow.document;
            doc.open();
            doc.write(code);
            doc.close();
          } catch (e) {
            outputContent.textContent = 'Error running code: ' + e;
          }
        }, 700); // Simulate processing delay
      }

      function checkAnswer() {
        const selectedChoice = document.querySelector('input[name="choice"]:checked');
        if (!selectedChoice) {
          alert("Please select an answer");
          return;
        }

        const isCorrect = selectedChoice.value === "true";

        // Random feedback messages
        const correctMessages = [
          "Perfect!", "Excellent!", "Brilliant!", "Spot on!", "Amazing!",
          "Fantastic!", "Outstanding!", "Superb!", "Wonderful!", "Great job!",
          "You got it!", "That's right!", "Exactly!", "Well done!", "Impressive!"
        ];

        const incorrectMessages = [
          "Not quite.", "You'll get it next time.", "Ouch, not really.", "Not exactly.", "Close!",
          "Nahh!", "Keep trying.", "Not quite right.", "Incorrect.", "Not this time.",
          "Oops, that's wrong.", "Not quite there.", "Try once more.", "Not the one.", "Nice try."
        ];

        // Get random message
        const randomMessage = isCorrect
          ? correctMessages[Math.floor(Math.random() * correctMessages.length)]
          : incorrectMessages[Math.floor(Math.random() * incorrectMessages.length)];

        // Get custom message if available
        const customMessage = isCorrect ? "{{ page.correct_message }}" : "";

        // Show feedback message
        const feedbackDiv = document.createElement("div");
        feedbackDiv.className = `alert ${isCorrect ? "alert-success" : "alert-danger"} mt-3`;
        feedbackDiv.innerHTML = `
          <div style="color: ${isCorrect ? '#28a745' : '#dc3545'}">${randomMessage}</div>
          ${customMessage ? `<div class="mt-2" style="color: #d3d3d3">${customMessage}</div>` : ''}
        `;
        document.querySelector(".quiz-choices").appendChild(feedbackDiv);

        // Disable all choices
        document.querySelectorAll('input[name="choice"]').forEach((input) => {
          input.disabled = true;
        });
        document.querySelector(".quiz-choices").classList.add("quiz-answered");

        // Show next button if correct
        if (isCorrect) {
          document.getElementById("next-btn").style.display = "block";
        }
      }

      // Add this function to properly initialize quiz choices
      function initializeQuizChoices() {
        const quizForm = document.getElementById('quiz-form');
        if (quizForm) {
          quizChoices = [];  // Reset quizChoices array
          quizForm.querySelectorAll('input[name="quiz_choice"]').forEach(input => {
            const choiceId = input.value;
            // Convert the data-is-correct attribute to a boolean
            const isCorrect = input.getAttribute('data-is-correct') === '1';
            quizChoices.push({ id: choiceId, is_correct: isCorrect });
            console.log('Added choice:', { id: choiceId, is_correct: isCorrect });
          });
          console.log('Quiz choices initialized:', quizChoices);  // Debug log
        }
      }

      function initializePlaygroundEditor() {
        if (window.codeMirrorInstance && window.codeMirrorInstance.toTextArea) {
          window.codeMirrorInstance.toTextArea();
          window.codeMirrorInstance = null;
        }
        var textarea = document.getElementById('playground-editor');
        if (textarea) {
          var mode = document.getElementById('playground-language') ? document.getElementById('playground-language').value : 'htmlmixed';
          window.codeMirrorInstance = CodeMirror.fromTextArea(textarea, {
            mode: mode,
            theme: 'material-darker',
            lineNumbers: true,
            autoCloseBrackets: true,
            autoCloseTags: true,
            matchTags: {bothTags: true},
            matchBrackets: true,
            styleActiveLine: true,
            foldGutter: true,
            gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
            extraKeys: {
              'Ctrl-Space': 'autocomplete',
              'Tab': function(cm) {
                if (cm.somethingSelected()) {
                  cm.indentSelection('add');
                } else {
                  cm.replaceSelection('  ', 'end');
                }
              },
              'Enter': 'newlineAndIndent'
            },
            hintOptions: {schemaInfo: CodeMirror.htmlSchema}
          });
          window.codeMirrorInstance.setSize('100%', '250px');
          window.codeMirrorInstance.on('inputRead', function(cm, change) {
            if (change.text[0] && /[a-zA-Z<]/.test(change.text[0])) {
              cm.showHint();
            }
          });
        }
        setupPlaygroundFullscreen();
      }

      function changePlaygroundMode(mode) {
        if (window.codeMirrorInstance) {
          window.codeMirrorInstance.setOption('mode', mode);
          window.codeMirrorInstance.focus();
        }
      }

      // Fullscreen logic
      function setupPlaygroundFullscreen() {
        var wrapper = document.getElementById('playground-fullscreen-wrapper');
        var outer = document.getElementById('playground-editor-outer');
        var output = document.getElementById('playground-output');
        var btn = document.getElementById('playground-fullscreen-btn');
        var editorHeader = outer.querySelector('.playground-header');
        var outputHeader = output.querySelector('.playground-output-header');
        var outputContent = document.getElementById('playground-output-content');
        if (!wrapper || !btn) return;
        btn.onclick = function() {
          var isFullscreen = wrapper.classList.toggle('fullscreen');
          if (isFullscreen) {
            btn.innerHTML = '<i class="fas fa-compress"></i>';
            output.style.display = 'flex';
            wrapper.style.position = 'absolute';
            wrapper.style.top = '0';
            wrapper.style.left = '0';
            wrapper.style.width = '100%';
            wrapper.style.height = '100%';
            if (editorHeader) editorHeader.style.display = 'block';
            if (outputHeader) outputHeader.style.display = 'block';
            if (outputContent && !outputContent.innerHTML.trim()) {
              outputContent.innerHTML = '<span class="playground-output-placeholder">No output yet</span>';
            }
            // Resize CodeMirror
            if (window.codeMirrorInstance) {
              setTimeout(function() { window.codeMirrorInstance.refresh(); }, 200);
            }
          } else {
            btn.innerHTML = '<i class="fas fa-expand"></i>';
            output.style.display = 'none';
            wrapper.style.position = '';
            wrapper.style.top = '';
            wrapper.style.left = '';
            wrapper.style.width = '';
            wrapper.style.height = '';
            if (editorHeader) editorHeader.style.display = 'none';
            if (outputHeader) outputHeader.style.display = 'none';
            if (outputContent) outputContent.innerHTML = '<span class="playground-output-placeholder">No output yet</span>';
            // Resize CodeMirror
            if (window.codeMirrorInstance) {
              setTimeout(function() { window.codeMirrorInstance.refresh(); }, 200);
            }
          }
        };
        // On initial fullscreen, show placeholder if no output
        if (wrapper.classList.contains('fullscreen') && outputContent && !outputContent.innerHTML.trim()) {
          outputContent.innerHTML = '<span class="playground-output-placeholder">No output yet</span>';
        }
      }

      document.addEventListener('DOMContentLoaded', setupPlaygroundFullscreen);
    </script>
  </body>
</html>
